<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Device Selection - Debug Asset vs ID Issue</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1, h2 {
            color: #333;
        }
        
        .route-selector {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        select {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .device-list {
            display: grid;
            gap: 15px;
        }
        
        .device-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .device-item.selected {
            border-color: #006dfe;
            background: #e6f2ff;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-info {
            flex: 1;
        }
        
        .cabinet-list {
            margin-top: 10px;
            padding-left: 20px;
            border-left: 3px solid #ddd;
        }
        
        .cabinet-item {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-output {
            font-family: monospace;
            font-size: 12px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #fffef0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        
        button {
            padding: 8px 16px;
            background: #006dfe;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056cc;
        }
        
        .warning {
            color: #ff6600;
            font-weight: bold;
        }
        
        .error {
            color: #ff0000;
            font-weight: bold;
        }
        
        .success {
            color: #00aa00;
            font-weight: bold;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Test Device Selection - Debug Asset vs ID Issue</h1>
    
    <div class="container">
        <h2>1. Load Route Data</h2>
        <div class="route-selector">
            <label for="route-select">Select Route: </label>
            <select id="route-select">
                <option value="">-- Select a route --</option>
            </select>
            <button onclick="loadRoutes()">Reload Routes</button>
        </div>
        
        <div class="debug-output" id="route-debug"></div>
    </div>
    
    <div class="container">
        <h2>2. Device Data Analysis</h2>
        <button onclick="analyzeDeviceData()">Analyze Loaded Devices</button>
        <div class="debug-output" id="analysis-output"></div>
    </div>
    
    <div class="comparison-grid">
        <div class="container">
            <h2>3A. Test with Inline Event Handlers</h2>
            <p>Original approach using inline onclick handlers</p>
            <div id="inline-devices" class="device-list"></div>
            <div class="test-section">
                <h3>Selected Items (Inline):</h3>
                <div class="debug-output" id="inline-selections"></div>
            </div>
        </div>
        
        <div class="container">
            <h2>3B. Test with Data Attributes</h2>
            <p>Alternative approach using data attributes</p>
            <div id="data-attr-devices" class="device-list"></div>
            <div class="test-section">
                <h3>Selected Items (Data Attributes):</h3>
                <div class="debug-output" id="data-attr-selections"></div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>4. Test Results</h2>
        <button onclick="compareSelections()">Compare Both Approaches</button>
        <button onclick="testServiceOrder()">Test Service Order Generation</button>
        <div class="debug-output" id="test-results"></div>
    </div>
    
    <div class="container">
        <h2>5. Export Test Report</h2>
        <p>Generate a comprehensive report of all test results for sharing and analysis.</p>
        <button onclick="generateReport()">Generate Report</button>
        <button onclick="copyReportToClipboard()">Copy Report to Clipboard</button>
        <button onclick="downloadReport()">Download Report as Text File</button>
        <div class="debug-output" id="export-report" style="display: none;"></div>
        <div id="export-status" style="margin-top: 10px;"></div>
    </div>
    
    <script src="/api.js"></script>
    <script>
        // Global state
        let currentRoute = null;
        let devices = [];
        let selectedDevicesInline = new Set();
        let selectedCabinetsInline = new Set();
        let selectedDevicesDataAttr = new Set();
        let selectedCabinetsDataAttr = new Set();
        
        // Initialize API
        const api = new CVDApi();
        
        // Debug logging
        function log(section, message, type = 'info') {
            const output = document.getElementById(section);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Load routes on page load
        window.onload = async function() {
            log('route-debug', 'Page loaded, initializing...');
            await loadRoutes();
        };
        
        // Load routes from API
        async function loadRoutes() {
            try {
                log('route-debug', 'Fetching routes from API...');
                const routes = await api.getRoutes();
                
                const select = document.getElementById('route-select');
                select.innerHTML = '<option value="">-- Select a route --</option>';
                
                routes.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.id;
                    option.textContent = `${route.name} (ID: ${route.id})`;
                    select.appendChild(option);
                });
                
                log('route-debug', `Loaded ${routes.length} routes`, 'success');
                
                // Add change handler
                select.onchange = handleRouteChange;
                
            } catch (error) {
                log('route-debug', `Failed to load routes: ${error.message}`, 'error');
            }
        }
        
        // Handle route selection
        async function handleRouteChange(event) {
            currentRoute = event.target.value;
            if (!currentRoute) {
                devices = [];
                renderDevices();
                return;
            }
            
            log('route-debug', `Selected route: ${currentRoute}`);
            
            try {
                log('route-debug', `Fetching devices for route ${currentRoute}...`);
                const response = await api.makeRequest('GET', `/routes/${currentRoute}/devices`);
                
                log('route-debug', `API Response: ${JSON.stringify(response).substring(0, 200)}...`);
                
                devices = response.devices || [];
                log('route-debug', `Loaded ${devices.length} devices`, 'success');
                
                // Clear selections
                selectedDevicesInline.clear();
                selectedCabinetsInline.clear();
                selectedDevicesDataAttr.clear();
                selectedCabinetsDataAttr.clear();
                
                // Render devices in both formats
                renderDevices();
                
                // Auto-analyze
                analyzeDeviceData();
                
            } catch (error) {
                log('route-debug', `Failed to load devices: ${error.message}`, 'error');
            }
        }
        
        // Analyze device data for issues
        function analyzeDeviceData() {
            const output = document.getElementById('analysis-output');
            output.textContent = '';
            
            if (devices.length === 0) {
                log('analysis-output', 'No devices loaded yet', 'warning');
                return;
            }
            
            log('analysis-output', `Analyzing ${devices.length} devices...`);
            
            // Check each device
            devices.forEach((device, index) => {
                log('analysis-output', `\nDevice ${index + 1}:`);
                log('analysis-output', `  ID: ${device.id} (type: ${typeof device.id})`);
                log('analysis-output', `  Asset: ${device.asset} (type: ${typeof device.asset})`);
                log('analysis-output', `  Cooler: ${device.cooler}`);
                log('analysis-output', `  Location: ${device.location}`);
                
                // Check for issues
                if (device.id == device.asset) {
                    log('analysis-output', `  ⚠️ ID equals Asset (with ==)`, 'warning');
                }
                if (device.id === device.asset) {
                    log('analysis-output', `  ❌ ID strictly equals Asset (with ===)`, 'error');
                }
                if (typeof device.id !== 'number') {
                    log('analysis-output', `  ⚠️ ID is not a number`, 'warning');
                }
                if (device.id > 100) {
                    log('analysis-output', `  ⚠️ ID > 100 (suspicious)`, 'warning');
                }
                
                // Check cabinets
                if (device.cabinets && device.cabinets.length > 0) {
                    log('analysis-output', `  Cabinets: ${device.cabinets.length}`);
                    device.cabinets.forEach((cab, i) => {
                        log('analysis-output', `    Cabinet ${i + 1}: Index=${cab.cabinetIndex}, Type=${cab.cabinetType}`);
                    });
                }
            });
            
            // Summary
            const suspiciousDevices = devices.filter(d => d.id > 100);
            if (suspiciousDevices.length > 0) {
                log('analysis-output', `\n❌ ISSUE DETECTED: ${suspiciousDevices.length} devices have ID > 100`, 'error');
                suspiciousDevices.forEach(d => {
                    log('analysis-output', `  Device ID ${d.id} has asset ${d.asset}`, 'error');
                });
            } else {
                log('analysis-output', '\n✅ All device IDs appear normal', 'success');
            }
        }
        
        // Render devices in both formats
        function renderDevices() {
            renderInlineDevices();
            renderDataAttrDevices();
            updateSelectionDisplays();
        }
        
        // Render with inline event handlers (original approach)
        function renderInlineDevices() {
            const container = document.getElementById('inline-devices');
            
            if (devices.length === 0) {
                container.innerHTML = '<p>No devices loaded</p>';
                return;
            }
            
            container.innerHTML = devices.map(device => {
                const isSelected = selectedDevicesInline.has(device.id);
                return `
                    <div class="device-item ${isSelected ? 'selected' : ''}">
                        <div class="device-header">
                            <div class="device-info">
                                <strong>Device #${device.asset}</strong> (ID: ${device.id})<br>
                                ${device.cooler} - ${device.location}
                            </div>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleDeviceInline(${device.id})"
                                   id="inline-device-${device.id}">
                        </div>
                        <div class="cabinet-list">
                            ${(device.cabinets || []).map(cabinet => {
                                const cabKey = getCabinetKey(device.id, cabinet.cabinetIndex);
                                const isCabSelected = selectedCabinetsInline.has(cabKey);
                                return `
                                    <div class="cabinet-item">
                                        <span>Cabinet ${cabinet.cabinetIndex + 1} - ${cabinet.cabinetType}</span>
                                        <input type="checkbox" ${isCabSelected ? 'checked' : ''}
                                               onchange="toggleCabinetInline(${device.id}, ${cabinet.cabinetIndex})"
                                               id="inline-cab-${device.id}-${cabinet.cabinetIndex}">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Render with data attributes (proposed fix)
        function renderDataAttrDevices() {
            const container = document.getElementById('data-attr-devices');
            
            if (devices.length === 0) {
                container.innerHTML = '<p>No devices loaded</p>';
                return;
            }
            
            container.innerHTML = devices.map(device => {
                const isSelected = selectedDevicesDataAttr.has(device.id);
                return `
                    <div class="device-item ${isSelected ? 'selected' : ''}">
                        <div class="device-header">
                            <div class="device-info">
                                <strong>Device #${device.asset}</strong> (ID: ${device.id})<br>
                                ${device.cooler} - ${device.location}
                            </div>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                   data-device-id="${device.id}"
                                   onchange="toggleDeviceDataAttr(event)"
                                   id="data-device-${device.id}">
                        </div>
                        <div class="cabinet-list">
                            ${(device.cabinets || []).map(cabinet => {
                                const cabKey = getCabinetKey(device.id, cabinet.cabinetIndex);
                                const isCabSelected = selectedCabinetsDataAttr.has(cabKey);
                                return `
                                    <div class="cabinet-item">
                                        <span>Cabinet ${cabinet.cabinetIndex + 1} - ${cabinet.cabinetType}</span>
                                        <input type="checkbox" ${isCabSelected ? 'checked' : ''}
                                               data-device-id="${device.id}"
                                               data-cabinet-index="${cabinet.cabinetIndex}"
                                               onchange="toggleCabinetDataAttr(event)"
                                               id="data-cab-${device.id}-${cabinet.cabinetIndex}">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Cabinet key helper
        function getCabinetKey(deviceId, cabinetIndex) {
            const key = `${deviceId}-${cabinetIndex}`;
            console.log(`getCabinetKey: deviceId=${deviceId}, cabinetIndex=${cabinetIndex}, key=${key}`);
            return key;
        }
        
        // Inline event handlers
        function toggleDeviceInline(deviceId) {
            console.log(`toggleDeviceInline called with deviceId=${deviceId} (type: ${typeof deviceId})`);
            
            if (selectedDevicesInline.has(deviceId)) {
                selectedDevicesInline.delete(deviceId);
            } else {
                selectedDevicesInline.add(deviceId);
            }
            
            updateSelectionDisplays();
        }
        
        function toggleCabinetInline(deviceId, cabinetIndex) {
            console.log(`toggleCabinetInline called with deviceId=${deviceId} (type: ${typeof deviceId}), cabinetIndex=${cabinetIndex}`);
            
            const key = getCabinetKey(deviceId, cabinetIndex);
            if (selectedCabinetsInline.has(key)) {
                selectedCabinetsInline.delete(key);
            } else {
                selectedCabinetsInline.add(key);
            }
            
            updateSelectionDisplays();
        }
        
        // Data attribute event handlers
        function toggleDeviceDataAttr(event) {
            const deviceId = parseInt(event.target.dataset.deviceId);
            console.log(`toggleDeviceDataAttr: deviceId=${deviceId} (type: ${typeof deviceId}) from data-device-id="${event.target.dataset.deviceId}"`);
            
            if (selectedDevicesDataAttr.has(deviceId)) {
                selectedDevicesDataAttr.delete(deviceId);
            } else {
                selectedDevicesDataAttr.add(deviceId);
            }
            
            updateSelectionDisplays();
        }
        
        function toggleCabinetDataAttr(event) {
            const deviceId = parseInt(event.target.dataset.deviceId);
            const cabinetIndex = parseInt(event.target.dataset.cabinetIndex);
            console.log(`toggleCabinetDataAttr: deviceId=${deviceId}, cabinetIndex=${cabinetIndex} from dataset`);
            
            const key = getCabinetKey(deviceId, cabinetIndex);
            if (selectedCabinetsDataAttr.has(key)) {
                selectedCabinetsDataAttr.delete(key);
            } else {
                selectedCabinetsDataAttr.add(key);
            }
            
            updateSelectionDisplays();
        }
        
        // Update selection displays
        function updateSelectionDisplays() {
            // Inline selections
            const inlineOutput = document.getElementById('inline-selections');
            inlineOutput.textContent = 'Selected Devices: ' + Array.from(selectedDevicesInline).join(', ') + '\n';
            inlineOutput.textContent += 'Selected Cabinets: ' + Array.from(selectedCabinetsInline).join(', ');
            
            // Data attr selections
            const dataAttrOutput = document.getElementById('data-attr-selections');
            dataAttrOutput.textContent = 'Selected Devices: ' + Array.from(selectedDevicesDataAttr).join(', ') + '\n';
            dataAttrOutput.textContent += 'Selected Cabinets: ' + Array.from(selectedCabinetsDataAttr).join(', ');
        }
        
        // Compare selections
        function compareSelections() {
            const output = document.getElementById('test-results');
            output.textContent = '';
            
            log('test-results', '=== Comparing Selections ===');
            
            // Compare device selections
            log('test-results', '\nDevice Selections:');
            log('test-results', `Inline: ${Array.from(selectedDevicesInline).sort().join(', ')}`);
            log('test-results', `Data Attr: ${Array.from(selectedDevicesDataAttr).sort().join(', ')}`);
            
            const devicesMatch = Array.from(selectedDevicesInline).sort().join(',') === 
                                Array.from(selectedDevicesDataAttr).sort().join(',');
            log('test-results', devicesMatch ? '✅ Device selections match!' : '❌ Device selections DO NOT match!', 
                devicesMatch ? 'success' : 'error');
            
            // Compare cabinet selections
            log('test-results', '\nCabinet Selections:');
            log('test-results', `Inline: ${Array.from(selectedCabinetsInline).sort().join(', ')}`);
            log('test-results', `Data Attr: ${Array.from(selectedCabinetsDataAttr).sort().join(', ')}`);
            
            const cabinetsMatch = Array.from(selectedCabinetsInline).sort().join(',') === 
                                 Array.from(selectedCabinetsDataAttr).sort().join(',');
            log('test-results', cabinetsMatch ? '✅ Cabinet selections match!' : '❌ Cabinet selections DO NOT match!', 
                cabinetsMatch ? 'success' : 'error');
            
            // Parse cabinet selections
            log('test-results', '\n=== Parsing Cabinet Selections ===');
            
            log('test-results', '\nInline Cabinet Parsing:');
            parseAndLogCabinets(selectedCabinetsInline, 'test-results');
            
            log('test-results', '\nData Attr Cabinet Parsing:');
            parseAndLogCabinets(selectedCabinetsDataAttr, 'test-results');
        }
        
        // Parse and log cabinet selections
        function parseAndLogCabinets(cabinetSet, outputId) {
            const parsed = [];
            cabinetSet.forEach(key => {
                const parts = key.split('-');
                if (parts.length >= 2) {
                    const deviceId = parseInt(parts[0]);
                    const cabinetIndex = parseInt(parts[1]);
                    parsed.push({ deviceId, cabinetIndex });
                    log(outputId, `  Key: "${key}" → deviceId: ${deviceId}, cabinetIndex: ${cabinetIndex}`);
                }
            });
            return parsed;
        }
        
        // Test service order generation
        async function testServiceOrder() {
            const output = document.getElementById('test-results');
            output.textContent = '';
            
            log('test-results', '=== Testing Service Order Generation ===');
            
            if (!currentRoute) {
                log('test-results', 'Please select a route first', 'error');
                return;
            }
            
            // Test with inline selections
            log('test-results', '\nTesting with INLINE selections:');
            const inlineCabinets = parseAndLogCabinets(selectedCabinetsInline, 'test-results');
            
            if (inlineCabinets.length > 0) {
                try {
                    log('test-results', 'Sending to API...');
                    const response = await api.makeRequest('POST', '/service-orders/preview', {
                        routeId: currentRoute,
                        serviceDate: new Date().toISOString().split('T')[0],
                        cabinetSelections: inlineCabinets
                    });
                    log('test-results', `Response: ${JSON.stringify(response)}`, 'success');
                } catch (error) {
                    log('test-results', `API Error: ${error.message}`, 'error');
                }
            }
            
            // Test with data attribute selections
            log('test-results', '\nTesting with DATA ATTRIBUTE selections:');
            const dataAttrCabinets = parseAndLogCabinets(selectedCabinetsDataAttr, 'test-results');
            
            if (dataAttrCabinets.length > 0) {
                try {
                    log('test-results', 'Sending to API...');
                    const response = await api.makeRequest('POST', '/service-orders/preview', {
                        routeId: currentRoute,
                        serviceDate: new Date().toISOString().split('T')[0],
                        cabinetSelections: dataAttrCabinets
                    });
                    log('test-results', `Response: ${JSON.stringify(response)}`, 'success');
                } catch (error) {
                    log('test-results', `API Error: ${error.message}`, 'error');
                }
            }
        }
        
        // Generate comprehensive report
        function generateReport() {
            const reportOutput = document.getElementById('export-report');
            const status = document.getElementById('export-status');
            
            let report = '=== CVD DEVICE SELECTION TEST REPORT ===\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Test Page: test-device-selection.html\n`;
            report += '\n';
            
            // 1. Environment Info
            report += '1. ENVIRONMENT INFORMATION\n';
            report += '==========================\n';
            report += `Browser: ${navigator.userAgent}\n`;
            report += `API Base URL: ${api.baseUrl}\n`;
            report += `Current Route: ${currentRoute || 'None selected'}\n`;
            report += '\n';
            
            // 2. Route Data
            report += '2. ROUTE DATA\n';
            report += '=============\n';
            const routeDebug = document.getElementById('route-debug').textContent;
            report += routeDebug || 'No route data logged\n';
            report += '\n';
            
            // 3. Device Analysis
            report += '3. DEVICE ANALYSIS\n';
            report += '==================\n';
            const analysisOutput = document.getElementById('analysis-output').textContent;
            report += analysisOutput || 'No analysis performed\n';
            report += '\n';
            
            // 4. Raw Device Data Sample
            report += '4. RAW DEVICE DATA (First 3 devices)\n';
            report += '====================================\n';
            if (devices.length > 0) {
                devices.slice(0, 3).forEach((device, i) => {
                    report += `\nDevice ${i + 1}:\n`;
                    report += JSON.stringify(device, null, 2) + '\n';
                });
            } else {
                report += 'No devices loaded\n';
            }
            report += '\n';
            
            // 5. Selection States
            report += '5. CURRENT SELECTIONS\n';
            report += '====================\n';
            report += 'Inline Approach:\n';
            report += `  Selected Devices: ${Array.from(selectedDevicesInline).sort().join(', ') || 'None'}\n`;
            report += `  Selected Cabinets: ${Array.from(selectedCabinetsInline).sort().join(', ') || 'None'}\n`;
            report += '\nData Attribute Approach:\n';
            report += `  Selected Devices: ${Array.from(selectedDevicesDataAttr).sort().join(', ') || 'None'}\n`;
            report += `  Selected Cabinets: ${Array.from(selectedCabinetsDataAttr).sort().join(', ') || 'None'}\n`;
            report += '\n';
            
            // 6. Test Results
            report += '6. TEST RESULTS\n';
            report += '===============\n';
            const testResults = document.getElementById('test-results').textContent;
            report += testResults || 'No tests run\n';
            report += '\n';
            
            // 7. Console Logs
            report += '7. CONSOLE LOG SUMMARY\n';
            report += '======================\n';
            report += 'Check browser console for detailed logs of:\n';
            report += '- getCabinetKey() calls\n';
            report += '- toggleDevice/Cabinet function calls\n';
            report += '- Event handler parameter values\n';
            report += '\n';
            
            // 8. Diagnostic Summary
            report += '8. DIAGNOSTIC SUMMARY\n';
            report += '====================\n';
            
            // Check for common issues
            const issues = [];
            const suspiciousDevices = devices.filter(d => d.id > 100);
            if (suspiciousDevices.length > 0) {
                issues.push(`❌ ${suspiciousDevices.length} devices have ID > 100 (possible asset/ID confusion)`);
                suspiciousDevices.forEach(d => {
                    issues.push(`   - Device ID ${d.id} has asset ${d.asset}`);
                });
            }
            
            const matchingIdAsset = devices.filter(d => d.id == d.asset);
            if (matchingIdAsset.length > 0) {
                issues.push(`⚠️  ${matchingIdAsset.length} devices have ID == asset`);
            }
            
            const nonNumericIds = devices.filter(d => typeof d.id !== 'number');
            if (nonNumericIds.length > 0) {
                issues.push(`⚠️  ${nonNumericIds.length} devices have non-numeric IDs`);
            }
            
            if (issues.length > 0) {
                report += 'Issues Found:\n';
                issues.forEach(issue => report += issue + '\n');
            } else {
                report += '✅ No obvious issues detected\n';
            }
            
            report += '\n';
            report += '=== END OF REPORT ===\n';
            
            // Display report
            reportOutput.textContent = report;
            reportOutput.style.display = 'block';
            status.innerHTML = '<span class="success">Report generated successfully!</span>';
            
            // Store for easy access
            window.lastGeneratedReport = report;
            
            return report;
        }
        
        // Copy report to clipboard
        async function copyReportToClipboard() {
            const status = document.getElementById('export-status');
            
            // Generate report if not already done
            const report = window.lastGeneratedReport || generateReport();
            
            try {
                await navigator.clipboard.writeText(report);
                status.innerHTML = '<span class="success">✅ Report copied to clipboard!</span>';
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = report;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    status.innerHTML = '<span class="success">✅ Report copied to clipboard!</span>';
                } catch (err) {
                    status.innerHTML = '<span class="error">❌ Failed to copy to clipboard</span>';
                }
                document.body.removeChild(textArea);
            }
        }
        
        // Download report as text file
        function downloadReport() {
            const status = document.getElementById('export-status');
            
            // Generate report if not already done
            const report = window.lastGeneratedReport || generateReport();
            
            // Create blob and download
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cvd-device-test-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            status.innerHTML = '<span class="success">✅ Report downloaded!</span>';
        }
    </script>
</body>
</html>