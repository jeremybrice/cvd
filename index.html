<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Device Configuration Tool</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#006dfe">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="stylesheet" href="/css/design-system.css">
    <style>
        /* Transitional styles - will be moved to component CSS */
        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Skip Navigation Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-primary-500);
            color: var(--color-neutral-0);
            padding: var(--space-sm) var(--space-md);
            text-decoration: none;
            z-index: var(--z-tooltip);
            border-radius: 0 0 var(--radius-md) 0;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            transition: top var(--duration-fast);
        }
        
        .skip-link:focus {
            top: 0;
            outline: var(--focus-width) solid var(--color-neutral-0);
            outline-offset: -4px;
        }
        
        .navbar {
            height: var(--nav-height);
            background: var(--color-primary-500);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding: 0 var(--space-lg);
            max-width: var(--container-xxl);
            margin: 0 auto;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .nav-logo {
            height: 40px;
            margin-right: var(--space-xl);
        }
        
        .nav-menu {
            display: flex;
            gap: 0;
        }
        
        .nav-button {
            background: var(--color-primary-500);
            color: var(--color-neutral-0);
            border: none;
            padding: var(--space-sm) var(--space-lg);
            font-size: var(--text-base);
            font-weight: var(--font-bold);
            cursor: pointer;
            transition: background-color var(--duration-fast);
            position: relative;
        }
        
        .nav-button:hover:not(.no-hover) {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-button.dropdown-open {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .nav-button:focus {
            outline: none; /* Remove browser default focus outline for dropdown buttons */
        }
        
        .nav-dropdown {
            position: relative;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--color-neutral-0);
            min-width: 180px;
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-md);
            z-index: var(--z-modal);
            display: none;
            padding: var(--space-sm) 0;
            overflow: hidden;
        }
        
        .dropdown-item {
            display: block;
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            min-height: var(--touch-target-min);
            display: flex;
            align-items: center;
            color: var(--color-neutral-800);
            text-decoration: none;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: var(--text-sm);
            transition: background-color var(--duration-fast);
            box-sizing: border-box;
        }
        
        .dropdown-item:hover {
            background: var(--color-neutral-50);
        }
        
        /* User dropdown styles */
        .user-dropdown {
            position: relative;
        }

        .user-button {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: var(--space-sm) var(--space-md);
            min-height: var(--touch-target-min);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--text-sm);
            transition: all var(--duration-fast);
        }

        .user-button:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        .user-button .username {
            font-weight: 500;
        }

        .user-button .role {
            opacity: 0.8;
            font-size: 12px;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .user-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .user-menu {
            right: 0;
            left: auto;
            min-width: 200px;
        }

        .user-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e1e5e8;
            background: #f5f5f5;
        }

        .user-menu-header strong {
            color: #333;
        }

        .user-menu-header small {
            color: #666;
            font-size: 12px;
        }
        
        .dropdown-divider {
            height: 0;
            margin: 8px 0;
            overflow: hidden;
            border-top: 1px solid #e1e5e8;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        .username {
            font-weight: 500;
        }
        
        .role {
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Breadcrumb Navigation */
        .breadcrumb {
            background: var(--color-neutral-50);
            border-bottom: 1px solid var(--color-neutral-200);
            padding: 0;
            min-height: var(--breadcrumb-height);
            display: flex;
            align-items: center;
        }
        
        .breadcrumb-container {
            max-width: var(--container-xxl);
            width: 100%;
            margin: 0 auto;
            padding: 0 var(--space-lg);
        }
        
        .breadcrumb-list {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
            padding: 0;
            list-style: none;
            font-size: var(--text-sm);
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            color: var(--color-neutral-600);
        }
        
        .breadcrumb-item::after {
            content: '/';
            margin: 0 var(--space-sm);
            color: var(--color-neutral-400);
        }
        
        .breadcrumb-item:last-child::after {
            display: none;
        }
        
        .breadcrumb-item:last-child {
            color: var(--color-neutral-800);
            font-weight: var(--font-medium);
        }
        
        .breadcrumb-link {
            color: var(--color-primary-500);
            text-decoration: none;
            transition: color var(--duration-fast);
        }
        
        .breadcrumb-link:hover {
            color: var(--color-primary-600);
            text-decoration: underline;
        }
        
        .breadcrumb-link:focus-visible {
            outline: var(--focus-width) solid var(--focus-color);
            outline-offset: var(--focus-offset);
            border-radius: var(--radius-sm);
        }
        
        .content-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #contentFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #006dfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Chat Widget - Global */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-widget.open {
            display: flex;
        }

        .chat-header {
            background: #006dfe;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-message.user {
            background: #006dfe;
            color: white;
            align-self: flex-end;
        }

        .chat-message.assistant {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e1e5e8;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e1e5e8;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #006dfe;
        }

        .chat-send {
            background: #006dfe;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-send:hover {
            background: #0056cc;
        }

        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #006dfe;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 109, 254, 0.3);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10001;
        }

        .chat-toggle:hover {
            background: #0056cc;
            transform: scale(1.1);
        }

        .chat-toggle.chat-open {
            display: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: #f1f3f4;
            border-radius: 12px;
            max-width: 85%;
            align-self: flex-start;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        /* ============================================
           P1: TOAST NOTIFICATION SYSTEM
           ============================================ */
        
        .toast-container {
            position: fixed;
            top: calc(var(--nav-height) + var(--space-md));
            right: var(--space-md);
            z-index: var(--z-toast);
            pointer-events: none;
        }
        
        .toast {
            background: var(--color-neutral-0);
            border-radius: var(--toast-radius);
            box-shadow: var(--toast-shadow);
            padding: var(--toast-padding);
            margin-bottom: var(--space-sm);
            min-width: 300px;
            max-width: 500px;
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            position: relative;
            pointer-events: all;
            transform: translateX(120%);
            transition: transform var(--duration-base) var(--ease-out);
            border-left: 4px solid;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.hiding {
            transform: translateX(120%);
            opacity: 0;
            transition: transform var(--duration-base) var(--ease-in),
                        opacity var(--duration-base) var(--ease-in);
        }
        
        .toast-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-message {
            color: var(--color-neutral-800);
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            margin: 0;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--color-neutral-500);
            cursor: pointer;
            padding: 0;
            font-size: 18px;
            line-height: 1;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color var(--duration-fast);
        }
        
        .toast-close:hover {
            color: var(--color-neutral-700);
        }
        
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.3;
            border-radius: 0 0 0 var(--radius-sm);
            transition: width linear;
        }
        
        /* Toast type variations */
        .toast.toast-success {
            border-left-color: var(--color-success);
        }
        
        .toast.toast-success .toast-icon {
            color: var(--color-success);
        }
        
        .toast.toast-error {
            border-left-color: var(--color-danger);
        }
        
        .toast.toast-error .toast-icon {
            color: var(--color-danger);
        }
        
        .toast.toast-warning {
            border-left-color: var(--color-warning);
        }
        
        .toast.toast-warning .toast-icon {
            color: var(--color-warning);
        }
        
        .toast.toast-info {
            border-left-color: var(--color-info);
        }
        
        .toast.toast-info .toast-icon {
            color: var(--color-info);
        }
        
        /* ============================================
           P1: COMMAND PALETTE
           ============================================ */
        
        .command-palette-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal-backdrop);
            display: none;
            opacity: 0;
            transition: opacity var(--duration-fast);
        }
        
        .command-palette-backdrop.active {
            display: block;
            opacity: 1;
        }
        
        .command-palette {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 90%;
            max-width: 600px;
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            z-index: var(--z-modal);
            display: none;
            flex-direction: column;
            max-height: 60vh;
            opacity: 0;
            transition: transform var(--duration-fast) var(--ease-out),
                        opacity var(--duration-fast);
        }
        
        .command-palette.active {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        
        .command-palette-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-neutral-200);
        }
        
        .command-palette-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            font-size: var(--text-lg);
            border: none;
            outline: none;
            background: transparent;
        }
        
        .command-palette-input::placeholder {
            color: var(--color-neutral-400);
        }
        
        .command-palette-results {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm) 0;
        }
        
        .command-palette-group {
            margin-bottom: var(--space-sm);
        }
        
        .command-palette-group-title {
            padding: var(--space-xs) var(--space-md);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--color-neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .command-palette-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            transition: background var(--duration-fast);
            text-decoration: none;
            color: var(--color-neutral-800);
        }
        
        .command-palette-item:hover,
        .command-palette-item.selected {
            background: var(--color-neutral-50);
        }
        
        .command-palette-item-icon {
            width: 20px;
            text-align: center;
            color: var(--color-neutral-500);
        }
        
        .command-palette-item-text {
            flex: 1;
        }
        
        .command-palette-item-shortcut {
            font-size: var(--text-xs);
            color: var(--color-neutral-400);
            font-family: var(--font-mono);
        }
        
        .command-palette-empty {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-neutral-500);
        }
        
        /* ============================================
           P1: ENHANCED LOADING STATES
           ============================================ */
        
        .loading-bar {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary-100);
            z-index: var(--z-tooltip);
            display: none;
        }
        
        .loading-bar.active {
            display: block;
        }
        
        .loading-bar-progress {
            height: 100%;
            background: var(--color-primary-500);
            transition: width var(--duration-base) var(--ease-out);
            box-shadow: 0 0 10px var(--color-primary-400);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--duration-base);
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-neutral-200);
            border-top: 3px solid var(--color-primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-message {
            margin-top: var(--space-md);
            color: var(--color-neutral-600);
            font-size: var(--text-sm);
        }
        
        .progress-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: var(--space-lg);
            min-width: 400px;
            z-index: var(--z-modal);
            display: none;
        }
        
        .progress-modal.active {
            display: block;
        }
        
        .progress-title {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--color-neutral-800);
            margin-bottom: var(--space-md);
        }
        
        .progress-bar {
            height: 8px;
            background: var(--color-neutral-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-sm);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary-500);
            transition: width var(--duration-base) var(--ease-out);
        }
        
        .progress-text {
            font-size: var(--text-sm);
            color: var(--color-neutral-600);
            text-align: center;
        }
        
        /* Navigation icon styles */
        .nav-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 6px;
            vertical-align: middle;
            opacity: 0.9;
        }
        
        /* SVG icon styles */
        .nav-icon svg {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Ensure SVG icons maintain consistent color */
        .nav-button .nav-icon svg {
            stroke: currentColor;
        }
        
        .dropdown-item .nav-icon svg {
            stroke: currentColor;
        }
        
        /* Keyboard shortcut hint */
        .nav-shortcut-hint {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            opacity: 0.5;
            font-family: var(--font-mono);
        }
    </style>
</head>
<body>
    <!-- Skip Navigation Link for Accessibility -->
    <a href="#contentFrame" class="skip-link">Skip to main content</a>
    
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <img src="images/365-logo.png" alt="365 Vision" class="nav-logo">
                <div class="nav-menu">
                    <div class="nav-dropdown">
                        <button class="nav-button" data-menu="routes">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <rect x="1" y="3" width="15" height="13"></rect>
                                <path d="m16 8 4-4-4-4"></path>
                                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                <circle cx="18.5" cy="18.5" r="2.5"></circle>
                            </svg>Services
                        </button>
                        <div class="dropdown-menu" id="routes-menu">
                            <a href="#route-schedule" class="dropdown-item" data-page="route-schedule.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>Route Schedule
                            </a>
                            <a href="#service-orders" class="dropdown-item" data-page="service-orders.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9l2 2 4-4"></path>
                                </svg>Service Orders
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10,9 9,9 8,9"></polyline>
                                </svg>Service History
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-dropdown">
                        <button class="nav-button" data-menu="assets">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>Devices
                        </button>
                        <div class="dropdown-menu" id="assets-menu">
                            <a href="#coolers" class="dropdown-item" data-page="PCP.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M20 6h-2.18a3 3 0 0 0-5.64 0H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2z"></path>
                                    <path d="M14 11a2 2 0 1 0-4 0c0 .5.21.97.58 1.3L12 14l1.42-1.7c.37-.33.58-.8.58-1.3z"></path>
                                </svg>Device List
                            </a>
                            <a href="#planogram" class="dropdown-item" data-page="NSPT.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                    <line x1="8" y1="13" x2="16" y2="13"></line>
                                    <line x1="8" y1="17" x2="12" y2="17"></line>
                                </svg>Planograms
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-dropdown">
                        <button class="nav-button" data-menu="analytics">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>Analytics
                        </button>
                        <div class="dropdown-menu" id="analytics-menu">
                            <a href="#asset-sales" class="dropdown-item" data-page="asset-sales.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>Device Performance
                            </a>
                            <a href="#product-sales" class="dropdown-item" data-page="product-sales.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                    <polyline points="17 6 23 6 23 12"></polyline>
                                </svg>Product Performance
                            </a>
                            <a href="#" class="dropdown-item">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <line x1="12" y1="9" x2="12" y2="13"></line>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>Device Issues
                            </a>
                            <a href="#" class="dropdown-item">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>Revenue Analysis
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-dropdown">
                        <button class="nav-button nav-settings" data-menu="settings">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 8v6m11-7h-6m-8 0H1m15.5-3.5L19 10l-2.5-2.5M9 14 6.5 16.5 4 14m11.5-8.5L19 3l-2.5 2.5M9 8 6.5 5.5 4 8"></path>
                            </svg>Management
                        </button>
                        <div class="dropdown-menu" id="settings-menu">
                            <a href="#" class="dropdown-item">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M3 21h18"></path>
                                    <path d="M5 21V7l8-4v18"></path>
                                    <path d="M19 21V11l-6-4"></path>
                                </svg>Customer Data
                            </a>
                            <a href="#company-settings" class="dropdown-item" data-page="company-settings.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>Company Data
                            </a>
                            <a href="#user-management" class="dropdown-item" data-page="user-management.html" style="display: none;" id="usersMenuItem">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>User Management
                            </a>
                            <a href="#activity-monitor" class="dropdown-item" id="activityMonitorMenuItem">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>Activity Monitor
                            </a>
                        </div>
                    </div>

                    <div class="nav-dropdown">
                        <button class="nav-button" data-menu="help">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>Help
                        </button>
                        <div class="dropdown-menu" id="help-menu">
                            <a href="#" class="dropdown-item">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                                    <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
                                </svg>Customer Support
                            </a>
                            <a href="#knowledge-base" class="dropdown-item" data-page="knowledge-base.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>Knowledge Base
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#database" class="dropdown-item" data-page="database-viewer.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                                </svg>Database Viewer
                            </a>
                            <a href="#dex-parser" class="dropdown-item" data-page="dex-parser.html">
                                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>DEX Parser
                            </a>
                        </div>
                    </div>

                </div>
            </div>
            <div class="nav-right" id="navRight">
                <!-- User info will be populated here -->
            </div>
        </div>
    </nav>
    
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb" aria-label="Breadcrumb" id="breadcrumbNav">
        <div class="breadcrumb-container">
            <ol class="breadcrumb-list" id="breadcrumbList">
                <li class="breadcrumb-item">
                    <a href="#home" class="breadcrumb-link">Home</a>
                </li>
            </ol>
        </div>
    </nav>
    
    <div class="content-container">
        <iframe id="contentFrame" src="pages/home-dashboard.html"></iframe>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-message">Loading...</div>
        </div>
    </div>
    
    <!-- P1: Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- P1: Command Palette -->
    <div class="command-palette-backdrop" id="commandPaletteBackdrop"></div>
    <div class="command-palette" id="commandPalette">
        <div class="command-palette-header">
            <input type="text" 
                   class="command-palette-input" 
                   id="commandPaletteInput" 
                   placeholder="Type a command or search..." 
                   autocomplete="off">
        </div>
        <div class="command-palette-results" id="commandPaletteResults"></div>
    </div>
    
    <!-- P1: Loading Bar -->
    <div class="loading-bar" id="loadingBar">
        <div class="loading-bar-progress" id="loadingBarProgress"></div>
    </div>
    
    <!-- P1: Progress Modal -->
    <div class="progress-modal" id="progressModal">
        <div class="progress-title" id="progressTitle">Processing...</div>
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="progress-text" id="progressText">0%</div>
    </div>

    <!-- Global AI Chat Widget -->
    <button class="chat-toggle" id="chatToggle">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" style="width: 24px; height: 24px;">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </button>
    
    <div class="chat-widget" id="chatWidget">
        <div class="chat-header">
            <span>Business Assistant</span>
            <button class="chat-close" id="chatClose">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                Hi! I'm your business assistant. I can analyze your sales data, suggest optimizations, and answer questions about your vending operation. What would you like to know?
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your business...">
            <button class="chat-send" id="chatSend">Send</button>
        </div>
    </div>
    
    <script src="/api.js"></script>
    <script src="/js/iframe-keyboard.js"></script>
    <script src="/js/toast-helper.js"></script>
    <script src="/js/loading-helper.js"></script>
    <!-- P2: Medium Priority Components -->
    <script src="/js/user-preferences.js"></script>
    <script src="/js/performance-monitor.js"></script>
    <script src="/js/user-avatar.js"></script>
    <script src="/js/recent-pages.js"></script>
    <script src="/js/enhanced-search.js"></script>
    <script src="/js/notification-badges.js"></script>
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
        // Configuration
        const allowedOrigin = window.location.origin;
        
        // P1: Command Palette Commands
        const commandPaletteCommands = [
            // Navigation
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>', text: 'Go to Dashboard', shortcut: 'Alt+H', action: () => navigateToHash('#home') },
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>', text: 'Device List', shortcut: 'Alt+D', action: () => navigateToHash('#coolers') },
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>', text: 'Planograms', shortcut: 'Alt+P', action: () => navigateToHash('#planogram') },
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>', text: 'Service Orders', action: () => navigateToHash('#service-orders') },
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>', text: 'Route Schedule', action: () => navigateToHash('#route-schedule') },
            { group: 'Navigation', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>', text: 'Analytics Dashboard', action: () => navigateToHash('#asset-sales') },
            
            // Actions
            { group: 'Actions', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="m12 8v8"/><path d="m8 12h8"/></svg>', text: 'Add New Device', action: () => navigateToHash('#new-device') },
            { group: 'Actions', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>', text: 'Refresh Data', shortcut: 'Ctrl+R', action: () => refreshCurrentPage() },
            { group: 'Actions', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,5 17,10"/><line x1="12" x2="12" y1="15" y2="5"/></svg>', text: 'Export Data', action: () => showExportOptions() },
            { group: 'Actions', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>', text: 'Search Devices', action: () => focusIframeSearch() },
            
            // User
            { group: 'User', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', text: 'My Profile', action: () => navigateToHash('#profile') },
            { group: 'User', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>', text: 'Logout', action: () => logout() },
            
            // Help
            { group: 'Help', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="m9,9a3,3 0 1,1 6,0c0,2-3,3-3,3"/><path d="M12 17h.01"/></svg>', text: 'Help Center', action: () => showHelp() },
            { group: 'Help', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="m6 8h.01"/><path d="m10 8h.01"/><path d="m14 8h.01"/><path d="m18 8h.01"/><path d="m8 12h.01"/><path d="m12 12h.01"/><path d="m16 12h.01"/><path d="M7 16h10"/></svg>', text: 'Keyboard Shortcuts', shortcut: '?', action: () => showKeyboardShortcuts() }
        ];
        
        // Breadcrumb configuration
        const breadcrumbRoutes = {
            '#home': ['Home'],
            '#coolers': ['Home', 'Assets', 'Device List'],
            '#new-device': ['Home', 'Assets', 'New Device'],
            '#planogram': ['Home', 'Assets', 'Planograms'],
            '#database': ['Home', 'Admin', 'Database Viewer'],
            '#company-settings': ['Home', 'Management', 'Company Data'],
            '#user-management': ['Home', 'Management', 'Users'],
            '#activity-monitor': ['Home', 'Management', 'Activity Monitor'],
            '#profile': ['Home', 'Profile'],
            '#route-planning': ['Home', 'Services', 'Route Planning'],
            '#route-schedule': ['Home', 'Services', 'Schedule Deliveries'],
            '#service-orders': ['Home', 'Services', 'Service Orders'],
            '#asset-sales': ['Home', 'Reports', 'Asset Sales'],
            '#product-sales': ['Home', 'Reports', 'Product Sales'],
            '#dex-parser': ['Home', 'Help', 'DEX Parser'],
            '#knowledge-base': ['Home', 'Help', 'Knowledge Base'],
            '#driver-app': ['Home', 'Driver App']
        };
        
        const pageRoutes = {
            '#home': 'pages/home-dashboard.html',
            '#coolers': 'pages/PCP.html',
            '#new-device': 'pages/INVD.html',
            '#planogram': 'pages/NSPT.html',
            '#database': 'pages/database-viewer.html',
            '#company-settings': 'pages/company-settings.html',
            '#user-management': 'pages/user-management.html',
            '#activity-monitor': 'pages/activity-monitor.html',
            '#profile': 'pages/profile.html',
            '#route-planning': 'pages/route-planning.html',
            '#route-schedule': 'pages/route-schedule.html',
            '#service-orders': 'pages/service-orders.html',
            '#asset-sales': 'pages/asset-sales.html',
            '#product-sales': 'pages/product-sales.html',
            '#dex-parser': 'pages/dex-parser.html',
            '#knowledge-base': 'pages/knowledge-base.html',
            '#driver-app': 'pages/driver-app/index.html'
        };
        
        // Navigation state
        let currentPage = 'pages/home-dashboard.html';
        let isNavigating = false;
        
        // Initialize navigation
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication first
            await checkAuth();
            
            // Handle dropdown menus
            setupDropdowns();
            
            // Handle hash routing
            setupRouting();
            
            // Handle iframe messages
            setupMessageHandlers();
            
            // Setup global chat widget
            setupGlobalChat();
            
            // P1: Initialize new features
            setupKeyboardNavigation();
            setupCommandPalette();
            setupToastSystem();
            setupEnhancedLoading();
            
            // P2: Initialize medium priority features
            initializeP2Components();
            
            // Load initial page based on hash
            const hash = window.location.hash || '#home';
            navigateToHash(hash);
        });
        
        // Authentication functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/current-user', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/pages/login.html';
                    return;
                }
                
                const data = await response.json();
                window.currentUser = data.user;
                
                // Check if user is a driver and redirect them
                if (data.user.role === 'driver') {
                    window.location.href = '/pages/driver-app/';
                    return;
                }
                
                // Update UI with user info
                updateUserInterface();
                
                // Apply role-based visibility
                applyRolePermissions();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/pages/login.html';
            }
        }
        
        function updateUserInterface() {
            const navRight = document.getElementById('navRight');
            navRight.innerHTML = `
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-button" onclick="toggleUserMenu(event)">
                        <span class="username">${window.currentUser.username}</span>
                        <span class="role">(${window.currentUser.role})</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="user-menu dropdown-menu" id="userMenu" style="display: none;">
                        <div class="user-menu-header">
                            <strong>${window.currentUser.username}</strong>
                            <br>
                            <small>${window.currentUser.email || 'No email set'}</small>
                        </div>
                        <a href="#profile" class="dropdown-item" onclick="closeUserMenu()">
                            Profile
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            Logout
                        </a>
                    </div>
                </div>
            `;
        }
        
        function toggleUserMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            const menu = document.getElementById('userMenu');
            const isOpen = menu.style.display !== 'none';
            
            // Close all other dropdowns
            closeAllDropdowns();
            
            // Toggle this menu
            menu.style.display = isOpen ? 'none' : 'block';
            dropdown.classList.toggle('open', !isOpen);
            
            if (!isOpen) {
                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', closeUserMenu);
                }, 0);
            }
        }
        
        function closeUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = 'none';
                dropdown.classList.remove('open');
            }
            document.removeEventListener('click', closeUserMenu);
        }
        
        function applyRolePermissions() {
            const role = window.currentUser.role;
            
            // Define menu permissions by role
            const menuPermissions = {
                'admin': ['all'], // Admin can see everything
                'manager': ['home', 'coolers', 'planogram', 'routes', 'service-orders', 'asset-sales', 'product-sales', 'company-settings'],
                'driver': ['home', 'coolers', 'routes', 'service-orders'],
                'viewer': ['home', 'coolers', 'routes', 'asset-sales', 'product-sales']
            };
            
            // Hide database viewer for non-admins
            if (role !== 'admin') {
                const dbLink = document.querySelector('a[href="#database"]');
                if (dbLink) dbLink.style.display = 'none';
            }
            
            // Hide DEX parser for non-admins and non-managers
            if (!['admin', 'manager'].includes(role)) {
                const dexLink = document.querySelector('a[href="#dex-parser"]');
                if (dexLink) dexLink.style.display = 'none';
            }
            
            // Update page routes to enforce permissions
            updatePageRoutesForRole(role);
        }
        
        function updatePageRoutesForRole(role) {
            // Remove restricted pages from routes based on role
            if (role !== 'admin') {
                delete pageRoutes['#database'];
                delete pageRoutes['#user-management'];
                delete pageRoutes['#activity-monitor'];
                // Hide Users menu item
                const usersMenuItem = document.getElementById('usersMenuItem');
                if (usersMenuItem) usersMenuItem.style.display = 'none';
                // Hide Activity Monitor menu item
                const activityMonitorMenuItem = document.getElementById('activityMonitorMenuItem');
                if (activityMonitorMenuItem) activityMonitorMenuItem.style.display = 'none';
            } else {
                // Show Users menu item for admins
                const usersMenuItem = document.getElementById('usersMenuItem');
                if (usersMenuItem) usersMenuItem.style.display = '';
                // Show Activity Monitor menu item for admins
                const activityMonitorMenuItem = document.getElementById('activityMonitorMenuItem');
                if (activityMonitorMenuItem) activityMonitorMenuItem.style.display = '';
            }
            
            if (!['admin', 'manager'].includes(role)) {
                delete pageRoutes['#dex-parser'];
                delete pageRoutes['#company-settings'];
            }
            
            if (!['admin', 'manager', 'driver'].includes(role)) {
                delete pageRoutes['#service-orders'];
            }
        }
        
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await cvdApi.logout();
            }
        }
        
        // Close all dropdowns helper function - make it globally available
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('dropdown-open');
                btn.blur(); // Remove focus to clear visual highlight
            });
            
            // Also close user menu
            closeUserMenu();
        }
        
        // Make closeAllDropdowns globally available for Recent menu
        window.closeAllDropdowns = closeAllDropdowns;
        
        // Setup dropdown functionality
        function setupDropdowns() {
            const dropdowns = document.querySelectorAll('.nav-dropdown');
            console.log('Setting up dropdowns:', dropdowns.length);
            
            dropdowns.forEach(dropdown => {
                const button = dropdown.querySelector('.nav-button');
                const menu = dropdown.querySelector('.dropdown-menu');
                
                if (!button || !menu) {
                    console.error('Missing button or menu in dropdown:', dropdown);
                    return;
                }
                
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Dropdown clicked:', button.textContent);
                    
                    // Check if this dropdown is currently open
                    const isOpen = menu.style.display === 'block';
                    
                    // Close all dropdowns first
                    closeAllDropdowns();
                    
                    // If it wasn't open, open it
                    if (!isOpen) {
                        menu.style.display = 'block';
                        button.classList.add('dropdown-open');
                    }
                    
                    console.log('Menu display:', menu.style.display);
                });
            });
            
            // Close dropdowns when clicking anywhere on the document
            document.addEventListener('click', () => {
                closeAllDropdowns();
            });
            
            // Also close dropdowns when clicking inside the iframe
            const iframe = document.getElementById('contentFrame');
            iframe.addEventListener('load', () => {
                try {
                    // Add click listener to iframe document
                    iframe.contentDocument.addEventListener('click', () => {
                        closeAllDropdowns();
                    });
                } catch (e) {
                    console.log('Could not add click listener to iframe:', e);
                }
            });
            
            // Handle dropdown item clicks
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't handle items with onclick handlers (like user menu items)
                    if (item.hasAttribute('onclick')) {
                        return;
                    }
                    
                    e.preventDefault();
                    closeAllDropdowns(); // Close dropdowns immediately when item is clicked
                    
                    const hash = item.getAttribute('href');
                    if (hash && hash !== '#') {
                        window.location.hash = hash;
                    }
                });
            });
            
            // Handle logo click to go to home dashboard
            const logo = document.querySelector('.nav-logo');
            if (logo) {
                logo.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = '#home';
                });
                logo.style.cursor = 'pointer';
            }
        }
        
        // Setup hash-based routing
        function setupRouting() {
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash;
                navigateToHash(hash);
            });
        }
        
        // Navigate based on hash
        function navigateToHash(hash) {
            const page = pageRoutes[hash];
            if (page && page !== currentPage) {
                navigateToPage(page);
                updateBreadcrumbs(hash);
            } else if (hash === '#home' || !hash) {
                updateBreadcrumbs('#home');
            }
        }
        
        // Update breadcrumb navigation
        function updateBreadcrumbs(hash) {
            const breadcrumbList = document.getElementById('breadcrumbList');
            const trail = breadcrumbRoutes[hash] || ['Home'];
            
            // Clear existing breadcrumbs
            breadcrumbList.innerHTML = '';
            
            // Build breadcrumb trail
            trail.forEach((crumb, index) => {
                const li = document.createElement('li');
                li.className = 'breadcrumb-item';
                
                if (index === trail.length - 1) {
                    // Current page (last item)
                    const span = document.createElement('span');
                    span.setAttribute('aria-current', 'page');
                    span.textContent = crumb;
                    li.appendChild(span);
                } else {
                    // Clickable link
                    const a = document.createElement('a');
                    a.className = 'breadcrumb-link';
                    
                    // Map breadcrumb text to hash
                    if (crumb === 'Home') {
                        a.href = '#home';
                    } else {
                        // Try to find matching hash for intermediate pages
                        a.href = '#';
                        a.onclick = (e) => {
                            e.preventDefault();
                            // For now, just go home for intermediate links
                            window.location.hash = '#home';
                        };
                    }
                    
                    a.textContent = crumb;
                    li.appendChild(a);
                }
                
                breadcrumbList.appendChild(li);
            });
        }
        
        // Navigate to a specific page
        function navigateToPage(page) {
            if (isNavigating) return;
            
            isNavigating = true;
            const iframe = document.getElementById('contentFrame');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Show loading overlay
            loadingOverlay.classList.add('active');
            
            // Update iframe source
            iframe.src = page;
            currentPage = page;
            
            // Hide loading overlay when iframe loads
            iframe.onload = () => {
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                    isNavigating = false;
                }, 300);
                
                // Re-attach click listener to new iframe content
                try {
                    iframe.contentDocument.addEventListener('click', () => {
                        closeAllDropdowns();
                    });
                } catch (e) {
                    console.log('Could not add click listener to iframe:', e);
                }
            };
        }
        
        // Setup message handlers for iframe communication
        function setupMessageHandlers() {
            window.addEventListener('message', (event) => {
                // Validate origin
                if (event.origin !== allowedOrigin) {
                    console.warn('Rejected message from unauthorized origin:', event.origin);
                    return;
                }
                
                const { type, payload } = event.data;
                
                switch (type) {
                    case 'NAVIGATE':
                        handleNavigate(payload);
                        break;
                        
                    case 'REQUEST_DEVICES':
                        handleDeviceRequest(event.source);
                        break;
                        
                    case 'DEVICE_ADDED':
                        handleDeviceAdded(payload);
                        break;
                        
                    case 'REFRESH_DATA':
                        broadcastToFrames({ type: 'REFRESH_DATA' });
                        break;
                        
                    case 'USER_UPDATED':
                        // Update current user data
                        if (payload.user) {
                            window.currentUser = { ...window.currentUser, ...payload.user };
                            updateUserInterface();
                        }
                        break;
                        
                    // P1: New message types
                    case 'SHOW_TOAST':
                        showToast(payload.toastType, payload.message, payload.duration, payload.options);
                        break;
                        
                    case 'KEYBOARD_EVENT':
                        handleIframeKeyboard(payload);
                        break;
                        
                    case 'SHOW_LOADING':
                        showLoadingOverlay(payload.message);
                        break;
                        
                    case 'HIDE_LOADING':
                        hideLoadingOverlay();
                        break;
                        
                    case 'SHOW_PROGRESS':
                        showProgressModal(payload.title, payload.percent);
                        break;
                        
                    case 'UPDATE_PROGRESS':
                        updateProgressModal(payload.percent, payload.title);
                        break;
                        
                    case 'HIDE_PROGRESS':
                        hideProgressModal();
                        break;
                        
                    default:
                        console.log('Unhandled message type:', type);
                }
            });
        }
        
        // Handle navigation requests from iframes
        function handleNavigate(payload) {
            const { page } = payload;
            
            // Map page names to hashes
            const pageToHash = {
                'coolers': '#coolers',
                'new-device': '#new-device',
                'planogram': '#planogram',
                'data-export': '#data-export'
            };
            
            const hash = pageToHash[page];
            if (hash) {
                window.location.hash = hash;
            }
        }
        
        // Handle device data requests
        function handleDeviceRequest(source) {
            // Device data should be fetched from API by the requesting page
            // This frame no longer stores or provides device data
            source.postMessage({
                type: 'DEVICES_DATA_DEPRECATED',
                message: 'Device data should be fetched from API',
                devices: []
            }, allowedOrigin);
        }
        
        // Handle new device notifications
        function handleDeviceAdded(payload) {
            // Broadcast to all frames
            broadcastToFrames({
                type: 'DEVICE_ADDED',
                device: payload.device
            });
        }
        
        // Broadcast message to all iframes
        function broadcastToFrames(message) {
            const iframe = document.getElementById('contentFrame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage(message, allowedOrigin);
            }
        }
        
        // Update active navigation state
        function updateActiveNav() {
            const hash = window.location.hash;
            
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Find and highlight active menu
            document.querySelectorAll('.dropdown-item').forEach(item => {
                if (item.getAttribute('href') === hash) {
                    const dropdown = item.closest('.nav-dropdown');
                    if (dropdown) {
                        dropdown.querySelector('.nav-button').classList.add('active');
                    }
                }
            });
        }
        
        // Update active nav on hash change
        window.addEventListener('hashchange', () => {
            updateActiveNav();
            updateBreadcrumbs(window.location.hash || '#home');
        });
        document.addEventListener('DOMContentLoaded', () => {
            updateActiveNav();
            updateBreadcrumbs(window.location.hash || '#home');
        });

        // Global Chat System
        let chatOpen = false;
        let chatApi = null;

        function setupGlobalChat() {
            // Wait for CVDApi to be available
            if (typeof CVDApi === 'undefined') {
                console.error('CVDApi not available, retrying in 100ms...');
                setTimeout(setupGlobalChat, 100);
                return;
            }
            
            // Initialize API client
            chatApi = new CVDApi();

            const chatToggle = document.getElementById('chatToggle');
            const chatWidget = document.getElementById('chatWidget');
            const chatClose = document.getElementById('chatClose');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');

            console.log('Chat elements found:', {
                toggle: !!chatToggle,
                widget: !!chatWidget,
                close: !!chatClose,
                input: !!chatInput,
                send: !!chatSend
            });

            if (!chatToggle || !chatWidget || !chatClose || !chatInput || !chatSend) {
                console.error('Some chat elements not found, chat setup failed');
                return;
            }

            chatToggle.addEventListener('click', () => {
                console.log('Chat toggle clicked');
                toggleGlobalChat();
            });

            chatClose.addEventListener('click', () => {
                toggleGlobalChat();
            });

            chatSend.addEventListener('click', () => {
                sendGlobalMessage();
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendGlobalMessage();
                }
            });
        }

        function toggleGlobalChat() {
            const chatToggle = document.getElementById('chatToggle');
            const chatWidget = document.getElementById('chatWidget');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatWidget.classList.add('open');
                chatToggle.classList.add('chat-open');
                document.getElementById('chatInput').focus();
            } else {
                chatWidget.classList.remove('open');
                chatToggle.classList.remove('chat-open');
            }
        }

        async function sendGlobalMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addGlobalMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showGlobalTyping();
            
            try {
                // Get comprehensive business context
                const context = await getBusinessContext();
                
                // Send message to backend
                const response = await chatApi.makeRequest('POST', '/chat', {
                    message: message,
                    context: context
                });
                
                // Remove typing indicator and add response
                hideGlobalTyping();
                addGlobalMessage(response.response, 'assistant');
                
            } catch (error) {
                console.error('Global chat error:', error);
                hideGlobalTyping();
                addGlobalMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        }

        async function getBusinessContext() {
            try {
                // Get comprehensive data from all APIs
                const [weeklyMetrics, timeline, achievements, topPerformers, salesSummary, devices] = await Promise.all([
                    chatApi.makeRequest('GET', '/metrics/weekly'),
                    chatApi.makeRequest('GET', '/metrics/timeline'),
                    chatApi.makeRequest('GET', '/metrics/achievements'),
                    chatApi.makeRequest('GET', '/metrics/top-performers'),
                    chatApi.makeRequest('GET', '/sales/summary'),
                    chatApi.makeRequest('GET', '/devices')
                ]);

                return {
                    weekly: weeklyMetrics,
                    timeline: timeline,
                    achievements: achievements,
                    performers: topPerformers,
                    salesSummary: salesSummary,
                    devices: devices,
                    pageContext: getCurrentPageContext()
                };
            } catch (error) {
                console.error('Error getting business context:', error);
                return { pageContext: getCurrentPageContext() };
            }
        }

        function getCurrentPageContext() {
            const currentHash = window.location.hash;
            const currentPath = pageRoutes[currentHash] || 'unknown';
            
            return {
                currentPage: currentHash,
                pagePath: currentPath,
                timestamp: new Date().toISOString()
            };
        }

        function addGlobalMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showGlobalTyping() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'globalTypingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideGlobalTyping() {
            const typingIndicator = document.getElementById('globalTypingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // ============================================
        // P1: KEYBOARD NAVIGATION
        // ============================================
        
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // Command palette (Cmd/Ctrl + K)
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    toggleCommandPalette();
                    return;
                }
                
                // Alt + number shortcuts for navigation
                if (e.altKey && !e.ctrlKey && !e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            toggleDropdown('routes');
                            break;
                        case '2':
                            e.preventDefault();
                            toggleDropdown('assets');
                            break;
                        case '3':
                            e.preventDefault();
                            toggleDropdown('analytics');
                            break;
                        case '4':
                            e.preventDefault();
                            toggleDropdown('settings');
                            break;
                        case '5':
                            e.preventDefault();
                            toggleDropdown('help');
                            break;
                        case 'h':
                        case 'H':
                            e.preventDefault();
                            navigateToHash('#home');
                            break;
                        case 'd':
                        case 'D':
                            e.preventDefault();
                            navigateToHash('#coolers');
                            break;
                        case 'p':
                        case 'P':
                            e.preventDefault();
                            navigateToHash('#planogram');
                            break;
                    }
                }
                
                // Refresh shortcut (Ctrl/Cmd + R)
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    refreshCurrentPage();
                }
                
                // Help shortcut (?)
                if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        showKeyboardShortcuts();
                    }
                }
            });
        }
        
        function handleIframeKeyboard(payload) {
            // Re-trigger keyboard event from iframe
            const event = new KeyboardEvent('keydown', {
                key: payload.key,
                code: payload.code,
                ctrlKey: payload.ctrlKey,
                metaKey: payload.metaKey,
                altKey: payload.altKey,
                shiftKey: payload.shiftKey,
                bubbles: true
            });
            document.dispatchEvent(event);
        }
        
        function toggleDropdown(menuName) {
            const button = document.querySelector(`[data-menu="${menuName}"]`);
            if (button) {
                button.click();
            }
        }
        
        function refreshCurrentPage() {
            const iframe = document.getElementById('contentFrame');
            showToast('info', 'Refreshing data...');
            iframe.contentWindow.location.reload();
            broadcastToFrames({ type: 'REFRESH_DATA' });
        }
        
        function focusIframeSearch() {
            const iframe = document.getElementById('contentFrame');
            iframe.contentWindow.postMessage({ type: 'FOCUS_SEARCH' }, allowedOrigin);
        }
        
        function showExportOptions() {
            showToast('info', 'Export feature coming soon!');
        }
        
        function showHelp() {
            window.open('https://docs.365retailmarkets.com', '_blank');
        }
        
        function showKeyboardShortcuts() {
            const shortcuts = [
                'Cmd/Ctrl + K: Open command palette',
                'Alt + 1-5: Open navigation menus',
                'Alt + H: Go to home',
                'Alt + D: Device list',
                'Alt + P: Planograms',
                'Ctrl/Cmd + R: Refresh data',
                '?: Show this help'
            ];
            showToast('info', shortcuts.join('\n'), 8000);
        }
        
        // ============================================
        // P1: COMMAND PALETTE
        // ============================================
        
        let commandPaletteOpen = false;
        let selectedCommandIndex = 0;
        let filteredCommands = [];
        
        function setupCommandPalette() {
            const backdrop = document.getElementById('commandPaletteBackdrop');
            const palette = document.getElementById('commandPalette');
            const input = document.getElementById('commandPaletteInput');
            const results = document.getElementById('commandPaletteResults');
            
            // Close on backdrop click
            backdrop.addEventListener('click', closeCommandPalette);
            
            // Close on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && commandPaletteOpen) {
                    closeCommandPalette();
                }
            });
            
            // Handle input
            input.addEventListener('input', (e) => {
                filterCommands(e.target.value);
            });
            
            // Handle keyboard navigation in palette
            input.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectNextCommand();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectPreviousCommand();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    executeSelectedCommand();
                }
            });
            
            // Initial render
            renderCommands('');
        }
        
        function toggleCommandPalette() {
            if (commandPaletteOpen) {
                closeCommandPalette();
            } else {
                openCommandPalette();
            }
        }
        
        function openCommandPalette() {
            const backdrop = document.getElementById('commandPaletteBackdrop');
            const palette = document.getElementById('commandPalette');
            const input = document.getElementById('commandPaletteInput');
            
            commandPaletteOpen = true;
            backdrop.classList.add('active');
            palette.classList.add('active');
            
            // Reset state
            input.value = '';
            selectedCommandIndex = 0;
            renderCommands('');
            
            // Focus input
            setTimeout(() => input.focus(), 100);
        }
        
        function closeCommandPalette() {
            const backdrop = document.getElementById('commandPaletteBackdrop');
            const palette = document.getElementById('commandPalette');
            
            commandPaletteOpen = false;
            backdrop.classList.remove('active');
            palette.classList.remove('active');
        }
        
        function filterCommands(query) {
            renderCommands(query);
        }
        
        function renderCommands(query) {
            const results = document.getElementById('commandPaletteResults');
            
            // Filter commands based on query
            if (query) {
                const lowerQuery = query.toLowerCase();
                filteredCommands = commandPaletteCommands.filter(cmd => 
                    cmd.text.toLowerCase().includes(lowerQuery) ||
                    (cmd.shortcut && cmd.shortcut.toLowerCase().includes(lowerQuery))
                );
            } else {
                filteredCommands = [...commandPaletteCommands];
            }
            
            // Group commands
            const groups = {};
            filteredCommands.forEach(cmd => {
                if (!groups[cmd.group]) {
                    groups[cmd.group] = [];
                }
                groups[cmd.group].push(cmd);
            });
            
            // Render HTML
            let html = '';
            
            if (Object.keys(groups).length === 0) {
                html = '<div class="command-palette-empty">No commands found</div>';
            } else {
                let index = 0;
                for (const [groupName, commands] of Object.entries(groups)) {
                    html += `
                        <div class="command-palette-group">
                            <div class="command-palette-group-title">${groupName}</div>
                    `;
                    
                    for (const cmd of commands) {
                        const isSelected = index === selectedCommandIndex;
                        html += `
                            <div class="command-palette-item ${isSelected ? 'selected' : ''}" 
                                 data-index="${index}">
                                <span class="command-palette-item-icon">${cmd.icon}</span>
                                <span class="command-palette-item-text">${cmd.text}</span>
                                ${cmd.shortcut ? `<span class="command-palette-item-shortcut">${cmd.shortcut}</span>` : ''}
                            </div>
                        `;
                        index++;
                    }
                    
                    html += '</div>';
                }
            }
            
            results.innerHTML = html;
            
            // Add click handlers
            results.querySelectorAll('.command-palette-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectedCommandIndex = index;
                    executeSelectedCommand();
                });
                
                item.addEventListener('mouseenter', () => {
                    const index = parseInt(item.dataset.index);
                    selectedCommandIndex = index;
                    updateSelectedCommand();
                });
            });
        }
        
        function selectNextCommand() {
            if (filteredCommands.length === 0) return;
            selectedCommandIndex = (selectedCommandIndex + 1) % filteredCommands.length;
            updateSelectedCommand();
        }
        
        function selectPreviousCommand() {
            if (filteredCommands.length === 0) return;
            selectedCommandIndex = selectedCommandIndex === 0 ? filteredCommands.length - 1 : selectedCommandIndex - 1;
            updateSelectedCommand();
        }
        
        function updateSelectedCommand() {
            const items = document.querySelectorAll('.command-palette-item');
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedCommandIndex);
            });
        }
        
        function executeSelectedCommand() {
            if (filteredCommands[selectedCommandIndex]) {
                const command = filteredCommands[selectedCommandIndex];
                closeCommandPalette();
                command.action();
            }
        }
        
        // ============================================
        // P1: TOAST NOTIFICATION SYSTEM
        // ============================================
        
        window.ToastManager = {
            toasts: [],
            
            show: function(type, message, duration, options) {
                showToast(type, message, duration, options);
            }
        };
        
        function setupToastSystem() {
            // System is ready, just need the functions
            console.log('Toast notification system initialized');
        }
        
        function showToast(type, message, duration = 5000, options = {}) {
            const container = document.getElementById('toastContainer');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Icons for each type
            const icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20,6 9,17 4,12"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>',
                warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="m12 16v-4"/><path d="M12 8h.01"/></svg>'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <p class="toast-message">${message}</p>
                </div>
                <button class="toast-close">×</button>
                ${options.showProgress ? '<div class="toast-progress"></div>' : ''}
            `;
            
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            // Handle close button
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto remove after duration
            if (duration > 0) {
                // Add progress bar animation if requested
                if (options.showProgress) {
                    const progress = toast.querySelector('.toast-progress');
                    if (progress) {
                        progress.style.transitionDuration = duration + 'ms';
                        requestAnimationFrame(() => {
                            progress.style.width = '100%';
                        });
                    }
                }
                
                setTimeout(() => {
                    removeToast(toast);
                }, duration);
            }
            
            // Store reference
            ToastManager.toasts.push(toast);
            
            return toast;
        }
        
        function removeToast(toast) {
            toast.classList.add('hiding');
            setTimeout(() => {
                toast.remove();
                const index = ToastManager.toasts.indexOf(toast);
                if (index > -1) {
                    ToastManager.toasts.splice(index, 1);
                }
            }, 300);
        }
        
        // ============================================
        // P1: ENHANCED LOADING STATES
        // ============================================
        
        window.LoadingManager = {
            handle: function(data) {
                switch(data.type) {
                    case 'SHOW_LOADING':
                        showLoadingOverlay(data.payload.message);
                        break;
                    case 'HIDE_LOADING':
                        hideLoadingOverlay();
                        break;
                    case 'SHOW_PROGRESS':
                        showProgressModal(data.payload.title, data.payload.percent);
                        break;
                    case 'UPDATE_PROGRESS':
                        updateProgressModal(data.payload.percent, data.payload.title);
                        break;
                    case 'HIDE_PROGRESS':
                        hideProgressModal();
                        break;
                }
            }
        };
        
        function setupEnhancedLoading() {
            // Enhance existing loading overlay
            const overlay = document.getElementById('loadingOverlay');
            const spinner = overlay.querySelector('.loading-spinner');
            
            // Add message element if not present
            if (!overlay.querySelector('.loading-message')) {
                const message = document.createElement('div');
                message.className = 'loading-message';
                message.textContent = 'Loading...';
                overlay.appendChild(message);
            }
            
            console.log('Enhanced loading system initialized');
        }
        
        function showLoadingOverlay(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = overlay.querySelector('.loading-message');
            
            if (messageEl) {
                messageEl.textContent = message;
            }
            
            overlay.classList.add('active');
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }
        
        function showLoadingBar(percent = 0) {
            const bar = document.getElementById('loadingBar');
            const progress = document.getElementById('loadingBarProgress');
            
            console.log(`Showing loading bar: ${percent}%`);
            bar.classList.add('active');
            progress.style.width = percent + '%';
        }
        
        function hideLoadingBar() {
            const bar = document.getElementById('loadingBar');
            const progress = document.getElementById('loadingBarProgress');
            
            if (!bar || !progress) {
                console.warn('Loading bar elements not found');
                return;
            }
            
            // Debug logging
            console.log('Hiding loading bar');
            
            // Immediately disable transition to avoid visual glitch
            progress.style.transition = 'none';
            
            // Reset progress to 0 and remove active class
            progress.style.width = '0%';
            bar.classList.remove('active');
            
            // Force hide with multiple methods to ensure it disappears
            bar.style.display = 'none';
            
            // Double-check after a short delay and force hide if still visible
            setTimeout(() => {
                if (bar.offsetHeight > 0 || bar.offsetWidth > 0) {
                    console.warn('Loading bar still visible, forcing hide');
                    bar.style.display = 'none !important';
                    bar.style.visibility = 'hidden';
                    bar.style.opacity = '0';
                }
                
                // Re-enable transition and reset styles for next use
                progress.style.transition = 'width var(--duration-base) var(--ease-out)';
                bar.style.display = '';  // Reset to CSS default
                bar.style.visibility = '';
                bar.style.opacity = '';
            }, 100);
        }
        
        function showProgressModal(title, percent = 0) {
            const modal = document.getElementById('progressModal');
            const titleEl = document.getElementById('progressTitle');
            const fill = document.getElementById('progressBarFill');
            const text = document.getElementById('progressText');
            
            titleEl.textContent = title;
            fill.style.width = percent + '%';
            text.textContent = percent + '%';
            
            modal.classList.add('active');
        }
        
        function updateProgressModal(percent, title) {
            const titleEl = document.getElementById('progressTitle');
            const fill = document.getElementById('progressBarFill');
            const text = document.getElementById('progressText');
            
            if (title) {
                titleEl.textContent = title;
            }
            
            fill.style.width = percent + '%';
            text.textContent = percent + '%';
        }
        
        function hideProgressModal() {
            const modal = document.getElementById('progressModal');
            modal.classList.remove('active');
        }
        
        // Override navigate function to show loading states
        const originalNavigateToPage = navigateToPage;
        function navigateToPage(page) {
            if (isNavigating) return;
            
            isNavigating = true;
            const iframe = document.getElementById('contentFrame');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Show enhanced loading overlay
            showLoadingOverlay('Loading page...');
            showLoadingBar(30);
            
            // Update iframe source
            iframe.src = page;
            currentPage = page;
            
            // Simulate progress
            setTimeout(() => showLoadingBar(60), 200);
            setTimeout(() => showLoadingBar(90), 400);
            
            // Failsafe: Force cleanup after 10 seconds if iframe never loads
            const failsafeTimeout = setTimeout(() => {
                console.warn('Loading bar failsafe triggered - iframe took too long to load');
                hideLoadingOverlay();
                hideLoadingBar();
                isNavigating = false;
            }, 10000);
            
            // Hide loading overlay when iframe loads
            iframe.onload = () => {
                clearTimeout(failsafeTimeout); // Cancel failsafe since iframe loaded successfully
                showLoadingBar(100);
                
                // Always ensure loading states are cleaned up, even if script injection fails
                const cleanupLoading = () => {
                    console.log('Cleaning up loading states');
                    hideLoadingOverlay();
                    hideLoadingBar();
                    isNavigating = false;
                };
                
                // Inject helper scripts into iframe
                try {
                    const doc = iframe.contentDocument;
                    if (doc) {
                        // Inject keyboard helper
                        const keyboardScript = doc.createElement('script');
                        keyboardScript.src = '/js/iframe-keyboard.js';
                        doc.head.appendChild(keyboardScript);
                        
                        // Inject toast helper
                        const toastScript = doc.createElement('script');
                        toastScript.src = '/js/toast-helper.js';
                        doc.head.appendChild(toastScript);
                        
                        // Inject loading helper
                        const loadingScript = doc.createElement('script');
                        loadingScript.src = '/js/loading-helper.js';
                        doc.head.appendChild(loadingScript);
                    }
                } catch (e) {
                    console.log('Could not inject helper scripts:', e);
                } finally {
                    // Ensure cleanup happens after loading bar completes transition to 100%
                    // Wait longer than CSS transition (250ms) plus a buffer
                    setTimeout(cleanupLoading, 400);
                }
                
                // Re-attach click listener to new iframe content
                try {
                    iframe.contentDocument.addEventListener('click', () => {
                        closeAllDropdowns();
                    });
                } catch (e) {
                    console.log('Could not add click listener to iframe:', e);
                }
            };
            
            // Handle iframe loading errors
            iframe.onerror = () => {
                clearTimeout(failsafeTimeout);
                console.error('Failed to load iframe page:', page);
                hideLoadingOverlay();
                hideLoadingBar();
                isNavigating = false;
                
                // Show error message to user
                if (window.showToast) {
                    showToast('Failed to load page', 'error');
                }
            };
        }
        
        // ============================================
        // P2: MEDIUM PRIORITY INITIALIZATION
        // ============================================
        
        function initializeP2Components() {
            console.log('Initializing P2 Medium Priority components...');
            
            // Wait for UI to be fully ready before initializing P2 components
            setTimeout(() => {
                // Verify required DOM elements exist before proceeding
                const navRight = document.querySelector('.nav-right');
                const navbar = document.querySelector('.navbar');
                
                console.log('DOM Check for P2 initialization:', {
                    navRight: !!navRight,
                    navbar: !!navbar,
                    currentUser: !!window.currentUser
                });
                
                if (!navRight || !navbar) {
                    console.error('Required DOM elements not found for P2 initialization:', {
                        navRight: !!navRight,
                        navbar: !!navbar
                    });
                    return;
                }
                
                // Initialize User Preferences Manager
                if (window.UserPreferences) {
                    console.log('UserPreferences system ready');
                    // Enable performance monitoring if preference is set
                    const enablePerformanceMonitoring = window.UserPreferences.get('performance', 'enablePerformanceMonitoring');
                    if (enablePerformanceMonitoring && window.PerformanceMonitor) {
                        window.PerformanceMonitor.enable();
                    }
                }
                
                // Initialize Performance Monitor
                if (window.PerformanceMonitor) {
                    console.log('PerformanceMonitor system ready');
                    // Enable by default if preferences allow
                    setTimeout(() => {
                        if (!window.UserPreferences || window.UserPreferences.get('performance', 'enablePerformanceMonitoring')) {
                            window.PerformanceMonitor.enable({
                                trackPageLoadTimes: true,
                                trackApiResponseTimes: true,
                                memoryMonitoring: false, // Off by default for performance
                                showIndicators: true,
                                enableAlerts: false // Off by default to avoid noise
                            });
                        }
                    }, 1000);
                }
                
                // Initialize User Avatar System
                if (window.UserAvatarSystem) {
                    console.log('UserAvatarSystem ready');
                    // Update navigation avatar when user is available
                    setTimeout(() => {
                        if (window.currentUser) {
                            window.UserAvatarSystem.updateNavigationAvatar();
                        }
                    }, 500);
                }
                
                // Initialize Recent Pages Tracker
                if (window.RecentPagesTracker) {
                    console.log('RecentPagesTracker ready');
                    // System auto-initializes via DOMContentLoaded
                }
                
                // Initialize Enhanced Search System with explicit DOM check
                if (window.EnhancedSearchSystem) {
                    console.log('EnhancedSearchSystem ready - verifying initialization');
                    
                    // Force re-initialization if elements are missing
                    const searchButton = document.querySelector('.search-trigger-btn');
                    if (!searchButton) {
                        console.log('Search trigger button missing, forcing re-initialization');
                        try {
                            // Create new instance - the original will be overwritten
                            window.EnhancedSearchSystem = new EnhancedSearchSystem();
                            console.log('Enhanced Search System re-initialized successfully');
                        } catch (error) {
                            console.error('Failed to reinitialize EnhancedSearchSystem:', error);
                        }
                    } else {
                        console.log('EnhancedSearchSystem already initialized with trigger button present');
                    }
                }
                
                // Initialize Notification Badge System
                if (window.NotificationBadgeSystem) {
                    console.log('NotificationBadgeSystem ready');
                    // System auto-initializes and starts monitoring
                }
                
                console.log('P2 Medium Priority components initialization complete');
                
                // Final verification - log what P2 UI elements were created
                setTimeout(() => {
                    const p2Elements = {
                        searchTrigger: !!document.querySelector('.search-trigger-btn'),
                        searchOverlay: !!document.querySelector('.search-overlay')
                    };
                    console.log('P2 UI Elements Created:', p2Elements);
                    
                    if (!p2Elements.searchTrigger) {
                        console.error('Enhanced Search ISSUE: Trigger button not created');
                    } else {
                        console.log('P2 Features successfully initialized and UI elements created');
                    }
                }, 500);
                
            }, 2000); // Wait 2 seconds to ensure all DOM elements and user data are ready
        }
    </script>
</body>
</html>