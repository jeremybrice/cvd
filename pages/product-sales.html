<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Sales Report - CVD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #006dfe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            font-size: 20px;
            font-weight: 600;
        }
        
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            font-weight: 600;
            border-bottom: 2px solid #006dfe;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range label {
            font-size: 14px;
            color: #666;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .date-range input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: #006dfe;
            color: white;
            border: 1px solid #006dfe;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: #0056cc;
        }
        
        .btn-secondary {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }
        
        .btn-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .btn-success:hover {
            background-color: #c3e6cb;
            border-color: #b1dfbb;
        }
        
        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            z-index: 1000;
            padding: 8px 0;
            margin-top: 2px;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background: #f5f5f5;
        }
        
        /* Focus indicators for accessibility */
        button:focus,
        input:focus,
        select:focus,
        a:focus {
            outline: 2px solid #006dfe;
            outline-offset: 2px;
        }
        
        /* Special case for buttons to maintain visual consistency */
        .btn:focus {
            outline: 2px solid #006dfe;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(0, 109, 254, 0.1);
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            padding: 30px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f5f5f5;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            border-bottom: 1px solid #dee2e6;
            position: relative;
            user-select: none;
        }
        
        /* Sortable Headers */
        .sortable-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        
        /* Sort Indicators */
        .sort-indicator {
            margin-left: 4px;
            font-size: 12px;
            color: #999;
        }
        
        .sortable-header.active .sort-indicator {
            color: #006dfe;
        }
        
        /* Filter Row */
        .filter-row td {
            padding: 8px 12px;
            background: #f5f5f5;
            border-bottom: 2px solid #dee2e6;
        }
        
        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .filter-input:focus {
            outline: 2px solid #006dfe;
            outline-offset: -1px;
            border-color: #006dfe;
        }
        
        /* Alternating Row Colors */
        .table tbody tr:nth-child(even):not(.filter-row) {
            background: #f9f9f9;
        }
        
        /* Row Hover Effect */
        .table tbody tr:hover:not(.filter-row) {
            background: #f0f4ff;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .table-loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #006dfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .table-error {
            text-align: center;
            padding: 40px 20px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .info {
            background-color: #e7f3ff;
            color: #006dfe;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #006dfe;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
        }
        
        #content {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <img src="/365-logo.png" alt="365 Retail Markets">
            <span>CVD Product Sales</span>
        </a>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>Product Sales Report</h1>
            <div class="controls">
                <div class="date-range">
                    <label>From:</label>
                    <input type="date" id="startDate" />
                    <label>To:</label>
                    <input type="date" id="endDate" />
                    <button class="btn btn-primary" onclick="loadSalesData()">
                        Update
                    </button>
                </div>
                <div class="dropdown">
                    <button class="btn btn-secondary" id="optionsBtn">
                        Options ▼
                    </button>
                    <div class="dropdown-menu" id="optionsDropdown">
                        <button class="dropdown-item" onclick="exportToCSV()">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="summary-stats" id="summaryStats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSales">$0</div>
                <div class="stat-label">Total Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgDaily">$0</div>
                <div class="stat-label">Average Daily Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dateRange">-</div>
                <div class="stat-label">Date Range</div>
            </div>
        </div>
        
        <div id="content">
            <div class="table-container">
                <div class="table-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading product sales data...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/api.js"></script>
    <script src="/auth-check.js"></script>
    <script>
        let salesData = [];
        let currentSort = {
            column: 'productId',
            direction: 'asc'
        };
        let activeFilters = {};
        
        // Initialize date inputs with current week (Sunday to Saturday)
        function initializeDates() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 0 : dayOfWeek));
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            document.getElementById('startDate').value = formatDate(startOfWeek);
            document.getElementById('endDate').value = formatDate(endOfWeek);
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        async function loadSalesData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showError('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                showError('Start date must be before end date');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${cvdApi.baseUrl}/sales/product-report?start_date=${startDate}&end_date=${endDate}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                salesData = data.products;
                
                updateSummaryStats(data);
                renderTable();
                
            } catch (error) {
                console.error('Error loading sales data:', error);
                showError('Failed to load sales data. Please try again.');
            }
        }
        
        function updateSummaryStats(data) {
            const totalProducts = data.products.length;
            const totalSales = data.products.reduce((sum, d) => sum + d.totalSales, 0);
            const avgDaily = totalSales / data.daysInRange;
            
            document.getElementById('totalDevices').textContent = totalProducts;
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('avgDaily').textContent = formatCurrency(avgDaily);
            document.getElementById('dateRange').textContent = `${data.daysInRange} days`;
            
            document.getElementById('summaryStats').style.display = 'grid';
        }
        
        // Apply filters to data
        function applyFiltersToData() {
            return salesData.filter(product => {
                for (const [column, filterValue] of Object.entries(activeFilters)) {
                    if (!filterValue || filterValue.trim() === '') continue;
                    
                    let productValue = '';
                    switch(column) {
                        case 'productId':
                            productValue = product.productId || '';
                            break;
                        case 'productName':
                            productValue = product.productName || '';
                            break;
                        case 'category':
                            productValue = product.category || '';
                            break;
                        case 'price':
                            productValue = formatCurrency(product.price);
                            break;
                        case 'totalSales':
                            productValue = formatCurrency(product.totalSales);
                            break;
                        case 'dailyAverage':
                            productValue = formatCurrency(product.dailyAverage);
                            break;
                        case 'totalUnits':
                            productValue = product.totalUnits.toString();
                            break;
                    }
                    
                    if (!productValue.toLowerCase().includes(filterValue.toLowerCase())) {
                        return false;
                    }
                }
                return true;
            });
        }
        
        function applyFilters() {
            applySorting();
        }
        
        function renderTable() {
            applySorting();
        }
        
        function renderTableData(dataToRender) {
            if (dataToRender.length === 0) {
                showNoData();
                return;
            }
            
            const html = `
                <div class="table-container">
                    <table id="salesTable" class="table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-column="productId">Product Number <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header" data-column="productName">Name <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header" data-column="category">Category <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header text-right" data-column="price">Price <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header text-right" data-column="totalSales">Total Sales <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header text-right" data-column="dailyAverage">Daily Average <span class="sort-indicator">↑</span></th>
                                <th class="sortable-header text-right" data-column="totalUnits">Units Sold <span class="sort-indicator">↑</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="filter-row">
                                <td><input type="text" class="filter-input" data-filter="productId" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="productName" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="category" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="price" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="totalSales" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="dailyAverage" placeholder="Filter..."></td>
                                <td><input type="text" class="filter-input" data-filter="totalUnits" placeholder="Filter..."></td>
                            </tr>
                            ${dataToRender.map(product => `
                                <tr>
                                    <td>${product.productId}</td>
                                    <td>${product.productName}</td>
                                    <td>${product.category}</td>
                                    <td class="text-right">${formatCurrency(product.price)}</td>
                                    <td class="text-right">${formatCurrency(product.totalSales)}</td>
                                    <td class="text-right">${formatCurrency(product.dailyAverage)}</td>
                                    <td class="text-right">${product.totalUnits}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }
        
        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            updateSortIndicators();
            applySorting();
        }
        
        function applySorting() {
            const filteredData = applyFiltersToData();
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];
                
                // Handle numeric columns
                if (['price', 'totalSales', 'dailyAverage', 'totalUnits'].includes(currentSort.column)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTableData(sortedData);
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                const column = header.dataset.column;
                
                header.classList.remove('active');
                
                if (column === currentSort.column) {
                    header.classList.add('active');
                    indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                } else {
                    indicator.textContent = '↑';
                }
            });
        }
        
        function exportToCSV() {
            if (salesData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Product Number', 'Name', 'Category', 'Price', 'Total Sales', 'Daily Average', 'Units Sold'];
            const rows = salesData.map(product => [
                product.productId,
                product.productName,
                product.category,
                product.price.toFixed(2),
                product.totalSales.toFixed(2),
                product.dailyAverage.toFixed(2),
                product.totalUnits
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-sales-${document.getElementById('startDate').value}-to-${document.getElementById('endDate').value}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function showLoading() {
            document.getElementById('content').innerHTML = `
                <div class="table-container">
                    <div class="table-loading">
                        <div class="loading-spinner"></div>
                        <p>Loading product sales data...</p>
                    </div>
                </div>
            `;
        }
        
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="table-container">
                    <div class="table-error">${message}</div>
                </div>
            `;
        }
        
        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.style.marginBottom = '20px';
            infoDiv.innerHTML = `
                <span>${message}</span>
                <button class="btn btn-primary" onclick="this.parentElement.remove()">OK</button>
            `;
            const content = document.getElementById('content');
            content.parentNode.insertBefore(infoDiv, content);
        }
        
        function showNoData() {
            document.getElementById('content').innerHTML = `
                <div class="table-container">
                    <div class="no-results">
                        <p>No product sales data found for the selected date range.</p>
                    </div>
                </div>
            `;
        }
        
        // PostMessage communication for iframe integration
        function sendMessageToParent(type, payload = {}) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: type,
                    payload: payload
                }, window.location.origin);
            }
        }
        
        // Listen for messages from parent frame
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            switch (event.data.type) {
                case 'REFRESH_DATA':
                    loadSalesData();
                    break;
                case 'REQUEST_REPORT':
                    loadSalesData();
                    break;
            }
        });
        
        // Initialize dropdown functionality
        function initializeDropdown() {
            const optionsBtn = document.getElementById('optionsBtn');
            const optionsDropdown = document.getElementById('optionsDropdown');
            
            // Toggle dropdown on button click
            optionsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                optionsDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    optionsDropdown.classList.remove('show');
                }
            });
            
            // Close dropdown after selecting an option
            optionsDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    optionsDropdown.classList.remove('show');
                });
            });
        }
        
        // Initialize event handlers
        function initializeTableHandlers() {
            // Initialize filters
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('filter-input')) {
                    const filterKey = e.target.dataset.filter;
                    activeFilters[filterKey] = e.target.value;
                    applyFilters();
                }
            });
            
            // Initialize sorting
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('sortable-header') || e.target.parentElement.classList.contains('sortable-header')) {
                    const header = e.target.classList.contains('sortable-header') ? e.target : e.target.parentElement;
                    const column = header.dataset.column;
                    handleSort(column);
                }
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Hide navigation bar if we're in an iframe
            if (window.parent !== window) {
                const navbar = document.querySelector('.navbar');
                if (navbar) {
                    navbar.style.display = 'none';
                    document.body.style.paddingTop = '20px';
                }
            }
            
            initializeDates();
            initializeDropdown();
            initializeTableHandlers();
            loadSalesData();
            
            // Notify parent frame that page is ready
            sendMessageToParent('PAGE_READY', { page: 'product-sales' });
        });
    </script>
</body>
</html>