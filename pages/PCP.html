<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoCooler Page - All PicoVision</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .coolers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .coolers-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .coolers-title h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
            border-bottom: 2px solid #006dfe;
            padding-bottom: 10px;
        }
        
        .showing-count {
            color: #666;
            font-size: 14px;
        }
        
        .coolers-controls {
            display: flex;
            gap: 10px;
        }
        
        .filter-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-control label {
            font-size: 14px;
            color: #666;
        }
        
        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .coolers-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .left-actions {
            display: flex;
            gap: 10px;
        }
        
        .right-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toggle-columns-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .toggle-columns-btn:hover {
            background: #f5f5f5;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .new-cooler-btn {
            background: #006dfe;
            color: white;
        }
        
        .new-cooler-btn:hover {
            background: #0056d3;
        }
        
        .alert-groups-btn,
        .prekit-groups-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .alert-groups-btn:hover,
        .prekit-groups-btn:hover {
            background: #f5f5f5;
        }
        
        .options-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            position: relative;
        }
        
        .options-btn:hover {
            background: #f5f5f5;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            z-index: 1000;
            padding: 8px 0;
            margin-top: 2px;
        }
        
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .dropdown-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .coolers-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            padding: 30px;
        }
        
        .coolers-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .coolers-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            border-bottom: 1px solid #dee2e6;
        }
        
        .coolers-table td {
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        
        .coolers-table tbody tr:nth-child(even):not(.filter-row) {
            background: #f9f9f9;
        }
        
        .coolers-table tbody tr:hover:not(.filter-row) {
            background: #f0f4ff;
        }
        
        .filter-row td {
            padding: 8px 12px;
            background: #f5f5f5;
            border-bottom: 2px solid #dee2e6;
        }
        
        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .filter-input:focus {
            outline: 2px solid #006dfe;
            outline-offset: -1px;
            border-color: #006dfe;
        }
        
        .no-results {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
            color: #666;
            line-height: 1.5;
        }
        
        .modal-actions {
            padding: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn-cancel {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-btn-cancel:hover {
            background: #e9e9e9;
        }
        
        .modal-btn-confirm {
            background: #dc3545;
            color: white;
        }
        
        .modal-btn-confirm:hover {
            background: #c82333;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .sortable-header:hover {
            background: #e9ecef;
        }
        
        .sort-indicator {
            margin-left: 4px;
            font-size: 12px;
            color: #999;
        }
        
        .sortable-header.active .sort-indicator {
            color: #006dfe;
        }
        
        /* Loading spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .table-loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #006dfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Error state styling */
        .table-error {
            text-align: center;
            padding: 40px 20px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        /* Checkbox styling */
        .coolers-table input[type="checkbox"] {
            cursor: pointer;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="coolers-header">
            <div class="coolers-title">
                <h1>All PicoVision</h1>
                <span class="showing-count">Showing: 0/0</span>
            </div>
            <div class="coolers-controls">
                <div class="filter-control">
                    <label>Filter</label>
                    <select class="filter-select">
                        <option>All (Connected)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="coolers-actions">
            <div class="left-actions">
                <div class="toggle-columns-control">
                    <button class="toggle-columns-btn">Toggle Columns ▼</button>
                </div>
            </div>
            <div class="right-actions">
                <button class="action-btn new-cooler-btn" id="newCoolerBtn">New Asset</button>
                <button class="action-btn alert-groups-btn">Alert Groups</button>
                <button class="action-btn prekit-groups-btn">Prekit Groups</button>
                <div style="position: relative;">
                    <button class="action-btn options-btn" id="optionsBtn">Options ▼</button>
                    <div class="dropdown-menu options-dropdown" id="optionsDropdown" style="display: none;">
                        <button class="dropdown-item" id="deleteBtn" disabled>Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="coolers-table-container">
            <table class="coolers-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox"></th>
                        <th class="sortable-header" data-column="asset">Asset <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="cooler">Name <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="location">Location <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="type">Type <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="model">Model <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="lastSale">Last Sale <span class="sort-indicator">↑</span></th>
                        <th class="sortable-header" data-column="lastService">Last Service <span class="sort-indicator">↑</span></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="filter-row">
                        <td></td>
                        <td><input type="text" class="filter-input" data-filter="asset"></td>
                        <td><input type="text" class="filter-input" data-filter="cooler"></td>
                        <td><input type="text" class="filter-input" data-filter="location"></td>
                        <td><input type="text" class="filter-input" data-filter="type"></td>
                        <td><input type="text" class="filter-input" data-filter="model"></td>
                        <td><input type="text" class="filter-input" data-filter="lastSale"></td>
                        <td><input type="text" class="filter-input" data-filter="lastService"></td>
                    </tr>
                </tbody>
            </table>
            <div class="no-results" id="noResults">
                No results found
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">Confirm Delete</div>
            <div class="modal-body" id="deleteModalBody">
                Are you sure you want to delete the selected items?
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="cancelDeleteBtn">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Include API module -->
    <script src="/api.js"></script>
    <script src="/auth-check.js"></script>
    
    <script>
        // Configuration
        const allowedOrigin = window.location.origin;
        
        // State management
        let savedDevices = [];
        let selectedRows = new Set();
        let currentSort = {
            column: 'asset',
            direction: 'asc'
        };
        
        let activeFilters = {
            asset: '',
            cooler: '',
            location: '',
            type: '',
            model: '',
            lastSale: '',
            lastService: ''
        };
        
        // Check API availability on load
        async function checkApiAvailability() {
            try {
                const health = await cvdApi.checkHealth();
                if (!health.available) {
                    throw new Error('API not available');
                }
                console.log('API available, using database');
                return true;
            } catch (error) {
                console.error('API unavailable:', error);
                showApiError();
                return false;
            }
        }
        
        // Show API error message
        function showApiError() {
            const container = document.querySelector('.coolers-table-container');
            container.innerHTML = `
                <div class="table-error">
                    <h3>Backend Server Not Running</h3>
                    <p>Please start the API server to use this application.</p>
                    <code style="background: #f8f9fa; padding: 8px 12px; border-radius: 4px; display: inline-block; margin-top: 10px;">python app.py</code>
                </div>
            `;
        }
        

        // Helper function to get device type display name
        function getDeviceTypeDisplay(device) {
            // Use deviceTypeDetails if available (from API)
            if (device.deviceTypeDetails && device.deviceTypeDetails.name) {
                return device.deviceTypeDetails.name;
            }
            // Fallback to device_type_id mapping
            if (device.device_type_id === 2) {
                return 'PicoVision Express';
            }
            // Default to PicoVision for device_type_id = 1 or undefined
            return 'PicoVision';
        }

        // Load devices from API
        async function loadDevicesFromStorage() {
            try {
                const devices = await cvdApi.getDevices();
                savedDevices = devices.map(device => ({
                    ...device,
                    // Ensure backward compatibility
                    cooler: device.cooler,
                    location: device.location,
                    model: device.model,
                    asset: device.asset
                }));
            } catch (error) {
                console.error('Failed to load devices from API:', error);
                savedDevices = [];
                throw error; // Propagate error to show message
            }
        }
        
        // Apply filters to devices
        function applyFilters() {
            const filteredDevices = savedDevices.filter(device => {
                for (const [key, filterValue] of Object.entries(activeFilters)) {
                    if (filterValue.trim() === '') continue;
                    
                    let deviceValue = '';
                    switch(key) {
                        case 'asset':
                            deviceValue = device.asset || '';
                            break;
                        case 'cooler':
                            deviceValue = device.cooler || '';
                            break;
                        case 'location':
                            deviceValue = device.location || '';
                            break;
                        case 'type':
                            deviceValue = getDeviceTypeDisplay(device);
                            break;
                        case 'model':
                            deviceValue = device.model || '';
                            break;
                        case 'lastSale':
                        case 'lastService':
                            deviceValue = '-';
                            break;
                    }
                    
                    if (!deviceValue.toLowerCase().includes(filterValue.toLowerCase())) {
                        return false;
                    }
                }
                return true;
            });
            
            const sortedDevices = sortDevices(filteredDevices);
            renderCoolersTable(sortedDevices);
        }
        
        // Sort devices based on current sort settings
        function sortDevices(devices) {
            return [...devices].sort((a, b) => {
                let aValue, bValue;
                
                switch(currentSort.column) {
                    case 'asset':
                        aValue = a.asset || '';
                        bValue = b.asset || '';
                        break;
                    case 'cooler':
                        aValue = a.cooler || '';
                        bValue = b.cooler || '';
                        break;
                    case 'location':
                        aValue = a.location || '';
                        bValue = b.location || '';
                        break;
                    case 'type':
                        aValue = getDeviceTypeDisplay(a);
                        bValue = getDeviceTypeDisplay(b);
                        break;
                    case 'model':
                        aValue = a.model || '';
                        bValue = b.model || '';
                        break;
                    case 'lastSale':
                    case 'lastService':
                        aValue = '-';
                        bValue = '-';
                        break;
                    default:
                        aValue = '';
                        bValue = '';
                }
                
                // Convert to lowercase for case-insensitive sorting
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
                
                if (aValue < bValue) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        
        // Handle header sorting
        function handleSort(column) {
            if (currentSort.column === column) {
                // Toggle direction if same column
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            updateSortIndicators();
            applyFilters(); // This will apply filters and then sort
        }
        
        // Update sort indicators in headers
        function updateSortIndicators() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                const column = header.dataset.column;
                
                header.classList.remove('active');
                
                if (column === currentSort.column) {
                    header.classList.add('active');
                    indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                } else {
                    indicator.textContent = '↑';
                }
            });
        }
        
        // Render the coolers table
        function renderCoolersTable(devicesToRender = null) {
            const devices = devicesToRender !== null ? devicesToRender : savedDevices;
            const tableBody = document.querySelector('.coolers-table tbody');
            const noResults = document.getElementById('noResults');
            const showingCount = document.querySelector('.showing-count');
            
            // Clear existing data rows (keep filter row)
            const existingDataRows = tableBody.querySelectorAll('tr:not(.filter-row)');
            existingDataRows.forEach(row => row.remove());
            
            // Reset select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            // Update count
            const filteredCount = devices.length;
            const totalCount = savedDevices.length;
            showingCount.textContent = `Showing: ${filteredCount}/${totalCount}`;
            
            if (devices.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Add data rows
            devices.forEach((device) => {
                const originalIndex = savedDevices.indexOf(device);
                const typeDisplay = getDeviceTypeDisplay(device);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-index="${originalIndex}"></td>
                    <td>${device.asset}</td>
                    <td>${device.cooler}</td>
                    <td>${device.location}</td>
                    <td>${typeDisplay}</td>
                    <td>${device.model}</td>
                    <td>-</td>
                    <td>-</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Initialize filters
        function initializeFilters() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('filter-input')) {
                    const filterKey = e.target.dataset.filter;
                    activeFilters[filterKey] = e.target.value;
                    applyFilters();
                }
            });
        }
        
        // Initialize table actions
        function initializeTableActions() {
            const optionsBtn = document.getElementById('optionsBtn');
            const optionsDropdown = document.getElementById('optionsDropdown');
            const deleteBtn = document.getElementById('deleteBtn');
            
            // Options dropdown
            optionsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const isOpen = optionsDropdown.style.display === 'block';
                optionsDropdown.style.display = isOpen ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                optionsDropdown.style.display = 'none';
            });
            
            // Checkbox handling
            document.addEventListener('change', function(e) {
                if (e.target.id === 'selectAllCheckbox') {
                    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                    selectedRows.clear();
                    
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                        if (e.target.checked) {
                            selectedRows.add(parseInt(checkbox.dataset.index));
                        }
                    });
                    
                    deleteBtn.disabled = selectedRows.size === 0;
                }
                
                if (e.target.classList.contains('row-checkbox')) {
                    const index = parseInt(e.target.dataset.index);
                    if (e.target.checked) {
                        selectedRows.add(index);
                    } else {
                        selectedRows.delete(index);
                    }
                    
                    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                    const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allChecked && rowCheckboxes.length > 0;
                    }
                    
                    deleteBtn.disabled = selectedRows.size === 0;
                }
            });
            
            // Delete functionality
            deleteBtn.addEventListener('click', function() {
                if (selectedRows.size > 0) {
                    const modal = document.getElementById('deleteModal');
                    const modalBody = document.getElementById('deleteModalBody');
                    modalBody.textContent = `Are you sure you want to delete ${selectedRows.size} selected item${selectedRows.size > 1 ? 's' : ''}?`;
                    modal.style.display = 'flex';
                    optionsDropdown.style.display = 'none';
                }
            });
            
            // Modal buttons
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                document.getElementById('deleteModal').style.display = 'none';
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                const indicesToDelete = Array.from(selectedRows).sort((a, b) => b - a);
                
                // Delete using API
                try {
                    const deviceIds = indicesToDelete.map(index => savedDevices[index].id);
                    await cvdApi.bulkDeleteDevices(deviceIds);
                    
                    // Remove from local array after successful API delete
                    indicesToDelete.forEach(index => {
                        savedDevices.splice(index, 1);
                    });
                } catch (error) {
                    console.error('Failed to delete devices:', error);
                    alert('Failed to delete devices. Please try again.');
                    document.getElementById('deleteModal').style.display = 'none';
                    return;
                }
                
                selectedRows.clear();
                deleteBtn.disabled = true;
                
                document.getElementById('deleteModal').style.display = 'none';
                
                // Notify parent frame
                sendMessageToParent('DEVICE_DELETED', { count: indicesToDelete.length });
                
                renderCoolersTable();
            });
        }
        
        // Handle New Cooler button
        function initializeNewCoolerButton() {
            const newCoolerBtn = document.getElementById('newCoolerBtn');
            newCoolerBtn.addEventListener('click', function() {
                sendMessageToParent('NAVIGATE', { page: 'new-device' });
            });
        }
        
        // Communication with parent frame
        function sendMessageToParent(type, payload = {}) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: type,
                    payload: payload,
                    timestamp: Date.now()
                }, allowedOrigin);
            }
        }
        
        // Listen for messages from parent
        function setupMessageHandlers() {
            window.addEventListener('message', (event) => {
                if (event.origin !== allowedOrigin) {
                    console.warn('Rejected message from unauthorized origin:', event.origin);
                    return;
                }
                
                const { type, payload } = event.data;
                
                switch (type) {
                    case 'DEVICE_ADDED':
                        loadDevicesFromStorage().then(() => renderCoolersTable());
                        break;
                        
                    case 'REFRESH_DATA':
                        loadDevicesFromStorage().then(() => renderCoolersTable());
                        break;
                        
                    default:
                        console.log('Unhandled message type:', type);
                }
            });
        }
        
        // Initialize sorting headers
        function initializeSortingHeaders() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.column;
                    handleSort(column);
                });
            });
            
            // Set initial sort indicators
            updateSortIndicators();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            // Check API availability first
            const apiAvailable = await checkApiAvailability();
            
            if (apiAvailable) {
                try {
                    // Load devices
                    await loadDevicesFromStorage();
                    renderCoolersTable();
                } catch (error) {
                    // Error already logged, UI updated
                }
            }
            
            // Initialize UI components (even if API fails, for better UX)
            initializeFilters();
            initializeTableActions();
            initializeNewCoolerButton();
            initializeSortingHeaders();
            setupMessageHandlers();
        });
    </script>
</body>
</html>